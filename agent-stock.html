<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Stock ‚Ä¢ Hawalina Ventures</title>
  <style>
    :root{
      --primary:#6f4cff;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;--info:#3b82f6;
      --line:#ece7ff;--muted:#6b6b7a;--text:#1f1f2a;
      --shadow:0 8px 24px rgba(25,10,70,.08);--r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:radial-gradient(1100px 500px at 60% 0%,rgba(111,76,255,.12),transparent 55%),#f7f4ff;
    }
    a{text-decoration:none;color:inherit}
    .app{display:flex;min-height:100vh}

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar{width:250px;padding:20px 16px;background:linear-gradient(180deg,#1a0a3c,#120730);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;flex-shrink:0}
    .brand{display:flex;gap:10px;align-items:center;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:12px}
    .brandIcon{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px;flex-shrink:0}
    .brand h2{font-size:15px;margin:0;line-height:1.2}
    .brand p{margin:2px 0 0;color:rgba(255,255,255,.55);font-size:11px}
    .nav{display:flex;flex-direction:column;gap:3px;flex:1}
    .nav a{padding:9px 11px;border-radius:11px;color:rgba(255,255,255,.75);display:flex;gap:9px;align-items:center;font-size:13px;transition:background .15s}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .navIco{width:17px;height:17px;border-radius:5px;display:inline-grid;place-items:center;background:rgba(255,255,255,.1);font-size:10px;flex-shrink:0}
    .sideFooter{margin-top:auto;padding-top:14px;border-top:1px solid rgba(255,255,255,.1)}
    .agentMeta{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .agentAvatar{width:36px;height:36px;border-radius:11px;background:rgba(255,255,255,.14);display:grid;place-items:center;font-size:16px;flex-shrink:0}
    .agentName{font-weight:700;font-size:13px;margin:0;color:#fff}
    .agentId{color:rgba(255,255,255,.5);font-size:11px;margin:2px 0 0}
    .logoutBtn{width:100%;padding:9px 12px;border-radius:11px;border:1px solid rgba(255,255,255,.14);background:transparent;color:rgba(255,255,255,.65);cursor:pointer;font-size:12px;display:flex;gap:8px;align-items:center;justify-content:center}
    .logoutBtn:hover{background:rgba(220,50,50,.2);color:#fff}

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main{flex:1;padding:28px 28px 60px;min-width:0}
    @media(max-width:640px){.sidebar{display:none}.main{padding:16px 14px 40px}}

    .topBar{margin-bottom:22px}
    .topBar h1{margin:0 0 4px;font-size:26px}
    .topBar p{margin:0;color:var(--muted);font-size:14px}

    /* ‚îÄ‚îÄ KPI bar ‚îÄ‚îÄ */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:13px;margin-bottom:20px}
    @media(max-width:1050px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.kpis{grid-template-columns:1fr}}
    .kpiCard{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);padding:15px 15px 17px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:11px;align-items:flex-start}
    .kpiCard::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px}
    .kpiCard.c-primary::before{background:linear-gradient(180deg,#6f4cff,#a78bfa)}
    .kpiCard.c-success::before{background:linear-gradient(180deg,#34d399,#10b981)}
    .kpiCard.c-warn::before{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
    .kpiCard.c-info::before{background:linear-gradient(180deg,#60a5fa,#3b82f6)}
    .kpiIco{width:44px;height:44px;border-radius:13px;background:rgba(111,76,255,.09);border:1px solid rgba(111,76,255,.16);display:grid;place-items:center;font-size:20px;flex-shrink:0}
    .kpiLabel{font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;font-weight:800;margin:0 0 5px}
    .kpiVal{font-size:21px;font-weight:900;margin:0 0 3px;color:var(--text)}
    .kpiHint{font-size:12px;color:var(--muted);margin:0}

    /* ‚îÄ‚îÄ Stock grid ‚îÄ‚îÄ */
    .stockGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    @media(max-width:500px){.stockGrid{grid-template-columns:1fr}}

    .stockCard{
      background:rgba(255,255,255,.92);border:1px solid var(--line);
      border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;
      transition:transform .15s,box-shadow .15s;
    }
    .stockCard:hover{transform:translateY(-2px);box-shadow:0 14px 32px rgba(25,10,70,.12)}
    .stockCard.low{border-color:rgba(245,158,11,.4)}
    .stockCard.out{border-color:rgba(239,68,68,.35);opacity:.75}

    .stockCardHead{
      padding:14px 16px 12px;
      display:flex;justify-content:space-between;align-items:flex-start;
      border-bottom:1px solid var(--line);
    }
    .stockProductName{font-weight:800;font-size:15px;margin:0 0 3px;color:var(--text)}
    .stockProductSub{font-size:12px;color:var(--muted);margin:0}
    .stockBadge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap}
    .stockBadge.ok{background:rgba(16,185,129,.1);color:var(--success)}
    .stockBadge.low{background:rgba(245,158,11,.12);color:var(--warn)}
    .stockBadge.out{background:rgba(239,68,68,.1);color:var(--danger)}

    .stockCardBody{padding:14px 16px}
    .statsRow{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
    .statCell{text-align:center}
    .statCellVal{font-size:17px;font-weight:900;color:var(--text);margin:0 0 2px}
    .statCellLabel{font-size:10px;color:var(--muted);text-transform:uppercase;font-weight:700;letter-spacing:.04em;margin:0}

    .progressWrap{margin-bottom:12px}
    .progressLabel{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:5px}
    .progressTrack{height:8px;border-radius:4px;background:rgba(111,76,255,.08);overflow:hidden}
    .progressFill{height:100%;border-radius:4px;background:linear-gradient(90deg,#6f4cff,#a78bfa);transition:width .5s ease}
    .progressFill.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
    .progressFill.danger{background:linear-gradient(90deg,#ef4444,#f87171)}

    .priceRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .pricePill{padding:4px 10px;border-radius:8px;font-size:12px;font-weight:700;background:rgba(111,76,255,.06);border:1px solid rgba(111,76,255,.14);color:var(--primary)}
    .pricePill.green{background:rgba(16,185,129,.07);border-color:rgba(16,185,129,.2);color:var(--success)}

    .actionBtn{
      width:100%;padding:10px;border-radius:10px;border:none;
      background:rgba(111,76,255,.08);color:var(--primary);
      font-size:13px;font-weight:700;cursor:pointer;margin-top:12px;
      transition:background .15s;
    }
    .actionBtn:hover{background:rgba(111,76,255,.16)}

    .empty{color:var(--muted);font-size:14px;text-align:center;padding:50px 0;grid-column:1/-1}
    .spinner{color:var(--muted);font-size:14px;text-align:center;padding:50px 0;grid-column:1/-1}
  </style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brandIcon">‚ú¶</div>
      <div><h2>Hawalina Ventures</h2><p>Agent Portal</p></div>
    </div>
    <nav class="nav">
      <a href="agent-dashboard.html"><span class="navIco">üß©</span>Dashboard</a>
      <a href="agent-record-sale.html"><span class="navIco">üí∞</span>Record Sale</a>
      <a href="agent-sales.html"><span class="navIco">üìã</span>My Sales</a>
      <a class="active" href="agent-stock.html"><span class="navIco">üì¶</span>My Stock</a>
      <a href="agent-commission.html"><span class="navIco">üíµ</span>My Commission</a>
      <a href="agent-performance.html"><span class="navIco">üìà</span>Performance</a>
    </nav>
    <div class="sideFooter">
      <div class="agentMeta">
        <div class="agentAvatar">üë§</div>
        <div>
          <p class="agentName" id="sidebarName">Loading...</p>
          <p class="agentId"   id="sidebarId">‚Äî</p>
        </div>
      </div>
      <button class="logoutBtn" id="logoutBtn">üö™ &nbsp;Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topBar">
      <h1>üì¶ My Current Stock</h1>
      <p>Live inventory ‚Äî distributed minus sold</p>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpiCard c-primary">
        <div class="kpiIco">üì¶</div>
        <div>
          <p class="kpiLabel">Total Units</p>
          <p class="kpiVal" id="kpiUnits">‚Äî</p>
          <p class="kpiHint">Available to sell</p>
        </div>
      </div>
      <div class="kpiCard c-success">
        <div class="kpiIco">üí∞</div>
        <div>
          <p class="kpiLabel">Stock Value</p>
          <p class="kpiVal" id="kpiValue">GHS ‚Äî</p>
          <p class="kpiHint">At agent price</p>
        </div>
      </div>
      <div class="kpiCard c-warn">
        <div class="kpiIco">üìä</div>
        <div>
          <p class="kpiLabel">Units Sold</p>
          <p class="kpiVal" id="kpiSold">‚Äî</p>
          <p class="kpiHint" id="kpiSoldRate">of total distributed</p>
        </div>
      </div>
      <div class="kpiCard c-info">
        <div class="kpiIco">üè∑Ô∏è</div>
        <div>
          <p class="kpiLabel">Product Types</p>
          <p class="kpiVal" id="kpiTypes">‚Äî</p>
          <p class="kpiHint" id="kpiLow">Loading‚Ä¶</p>
        </div>
      </div>
    </div>

    <!-- Stock cards -->
    <div class="stockGrid" id="stockGrid">
      <p class="spinner">Loading your stock‚Ä¶</p>
    </div>

  </main>
</div>

<script type="module">
  import { requireRole, logout, onAuthChange } from './auth.js';
  import { getAllAgents, getDistributions, getSales } from './firestore-db.js';

  async function init() {
    const allowed = await requireRole('agent');
    if (!allowed) return;

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await logout();
        window.location.href = 'index.html';
      }
    });

    onAuthChange(async (user) => {
      if (!user) return;

      const allRes = await getAllAgents();
      if (!allRes.success) return;

      // Retry up to 3 times with backoff ‚Äî Firestore can be slow on first load
      let allAgentsData = allRes.data;
      let match = allAgentsData.find(a => a.firebaseUid === user.uid);
      if (!match) {
        for (let attempt = 2; attempt <= 3; attempt++) {
          await new Promise(r => setTimeout(r, attempt * 800));
          const retryRes = await getAllAgents();
          if (retryRes.success && retryRes.data.length > 0) {
            match = retryRes.data.find(a => a.firebaseUid === user.uid);
            if (match) break;
          }
        }
      }
      if (!match) {
        document.getElementById('sidebarName').textContent = 'Profile error';
        document.getElementById('sidebarId').textContent   = 'Contact admin';
        console.warn('Agent profile not found for uid:', user.uid);
        return;
      }

      document.getElementById('sidebarName').textContent = match.fullName || match.name || 'Agent';
      document.getElementById('sidebarId').textContent   = match.nationalId || '‚Äî';

      await loadStock(match.id);
    });
  }

  // ‚îÄ‚îÄ Build inventory map from distributions minus sales ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadStock(agentId) {
    const [distRes, salesRes] = await Promise.all([
      getDistributions(agentId),
      getSales(agentId)
    ]);

    const distributions = distRes.success  ? distRes.data  : [];
    const sales         = salesRes.success ? salesRes.data : [];

    const map = {};

    distributions.forEach(d => {
      const items = d.items && d.items.length
        ? d.items
        : [{ hairBrand: d.hairBrand, color: d.color, length: d.length, quantity: d.quantity, agentPrice: d.agentPrice || d.pricePerUnit, sellingPrice: d.sellingPrice }];

      items.forEach(item => {
        const key = makeKey(item.hairBrand, item.color, item.length);
        if (!map[key]) {
          map[key] = {
            hairBrand:    item.hairBrand    || d.hairBrand    || '?',
            color:        item.color        || d.color        || '',
            length:       item.length       || d.length       || '',
            agentPrice:   item.agentPrice   || d.agentPrice   || d.pricePerUnit || 0,
            sellingPrice: item.sellingPrice || d.sellingPrice || 0,
            received: 0,
            sold: 0,
          };
        }
        map[key].received += (item.quantity || 0);
      });
    });

    sales.forEach(s => {
      const items = s.items && s.items.length
        ? s.items
        : [{ hairBrand: s.hairBrand || s.brand, color: s.color, length: s.length, quantity: s.quantity }];

      items.forEach(item => {
        const key = makeKey(item.hairBrand, item.color, item.length);
        if (map[key]) {
          map[key].sold += (item.quantity || 0);
        } else {
          map[key] = {
            hairBrand: item.hairBrand || s.hairBrand || s.brand || '?',
            color: item.color || s.color || '',
            length: item.length || s.length || '',
            agentPrice: 0, sellingPrice: 0,
            received: 0, sold: item.quantity || 0
          };
        }
      });
    });

    renderKPIs(map);
    renderCards(map);
  }

  function renderKPIs(map) {
    const entries    = Object.values(map);
    const totalSold  = entries.reduce((s, v) => s + v.sold, 0);
    const totalRec   = entries.reduce((s, v) => s + v.received, 0);
    const totalAvail = entries.reduce((s, v) => s + Math.max(0, v.received - v.sold), 0);
    const totalVal   = entries.reduce((s, v) => s + Math.max(0, v.received - v.sold) * (v.agentPrice || 0), 0);
    const types      = entries.length;
    const lowCount   = entries.filter(v => { const a = Math.max(0, v.received - v.sold); return a > 0 && a <= 3; }).length;
    const sellRate   = totalRec > 0 ? ((totalSold / totalRec) * 100).toFixed(0) : 0;

    document.getElementById('kpiUnits').textContent    = totalAvail.toLocaleString();
    document.getElementById('kpiValue').textContent    = 'GHS ' + fmt(totalVal);
    document.getElementById('kpiSold').textContent     = totalSold.toLocaleString();
    document.getElementById('kpiSoldRate').textContent = `${sellRate}% sell-through rate`;
    document.getElementById('kpiTypes').textContent    = types;
    document.getElementById('kpiLow').textContent      = lowCount > 0
      ? `‚ö†Ô∏è ${lowCount} product${lowCount !== 1 ? 's' : ''} running low`
      : '‚úÖ All stocked';
  }

  function renderCards(map) {
    const grid    = document.getElementById('stockGrid');
    const entries = Object.values(map);

    if (!entries.length) {
      grid.innerHTML = '<p class="empty">No stock has been assigned to you yet.<br>Contact your admin to distribute stock.</p>';
      return;
    }

    // Sort: most available first, out-of-stock last
    entries.sort((a, b) => Math.max(0, b.received - b.sold) - Math.max(0, a.received - a.sold));

    grid.innerHTML = entries.map(item => {
      const avail      = Math.max(0, item.received - item.sold);
      const pct        = item.received > 0 ? Math.round((avail / item.received) * 100) : 0;
      const isOut      = avail === 0;
      const isLow      = !isOut && avail <= 3;
      const cardCls    = isOut ? 'out' : isLow ? 'low' : '';
      const badgeCls   = isOut ? 'out' : isLow ? 'low' : 'ok';
      const badgeTxt   = isOut ? 'Out of Stock' : isLow ? 'Low Stock' : 'In Stock';
      const barCls     = pct <= 20 ? 'danger' : pct <= 50 ? 'warn' : '';
      const name       = [item.hairBrand, item.color, item.length ? `${item.length}"` : ''].filter(Boolean).join(' ');
      const stockValue = avail * (item.agentPrice || 0);

      return `<div class="stockCard ${cardCls}">
        <div class="stockCardHead">
          <div>
            <p class="stockProductName">${esc(name)}</p>
            <p class="stockProductSub">${esc(item.hairBrand || '‚Äî')}${item.color ? ' ¬∑ ' + esc(item.color) : ''}</p>
          </div>
          <span class="stockBadge ${badgeCls}">${badgeTxt}</span>
        </div>
        <div class="stockCardBody">
          <div class="statsRow">
            <div class="statCell">
              <p class="statCellVal" style="color:var(--primary);font-size:22px">${avail}</p>
              <p class="statCellLabel">Available</p>
            </div>
            <div class="statCell">
              <p class="statCellVal">${item.received}</p>
              <p class="statCellLabel">Received</p>
            </div>
            <div class="statCell">
              <p class="statCellVal">${item.sold}</p>
              <p class="statCellLabel">Sold</p>
            </div>
            <div class="statCell">
              <p class="statCellVal">${pct}%</p>
              <p class="statCellLabel">Remaining</p>
            </div>
          </div>

          <div class="progressWrap">
            <div class="progressLabel">
              <span>Stock level</span>
              <span>${avail} of ${item.received} units</span>
            </div>
            <div class="progressTrack">
              <div class="progressFill ${barCls}" style="width:${pct}%"></div>
            </div>
          </div>

          <div class="priceRow">
            ${item.agentPrice   ? `<span class="pricePill">Cost: GHS ${fmt(item.agentPrice)}</span>`   : ''}
            ${item.sellingPrice ? `<span class="pricePill green">Sell: GHS ${fmt(item.sellingPrice)}</span>` : ''}
            ${stockValue > 0    ? `<span class="pricePill">Value: GHS ${fmt(stockValue)}</span>`       : ''}
          </div>

          ${avail > 0 ? `<button class="actionBtn" onclick="location.href='agent-record-sale.html'">üí∞ Record a Sale</button>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  function makeKey(brand, color, length) {
    return `${brand || '?'}|${color || ''}|${length || '?'}`;
  }
  function fmt(n) {
    return Number(n || 0).toLocaleString('en-GH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function esc(str) {
    return String(str ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  init();
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agent Management â€¢ Hawalina Ventures</title>
  <style>
    :root{
      --bg:#f7f4ff;--panel:#ffffff;--text:#1f1f2a;--muted:#6b6b7a;
      --primary:#6f4cff;--primary2:#8b6bff;--line:#ece7ff;
      --shadow:0 10px 25px rgba(25,10,70,.08);--r:18px;
      --danger:#ef4444;--danger-bg:rgba(239,68,68,.08);
      --success:#10b981;--warn:#f59e0b;--info:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
      background:radial-gradient(1200px 600px at 70% 0%,rgba(111,76,255,.22),transparent 55%),
                 radial-gradient(900px 500px at 0% 30%,rgba(139,107,255,.14),transparent 60%),var(--bg);}
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;padding:22px 18px;background:linear-gradient(180deg,#24134f,#1a1036);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;}
    .brand{display:flex;gap:12px;align-items:center;padding:10px 10px 18px}
    .logo{width:46px;height:46px;border-radius:16px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px}
    .brand h1{font-size:18px;margin:0;line-height:1.1}
    .brand p{margin:4px 0 0;color:rgba(255,255,255,.7);font-size:12px}
    .nav{margin-top:10px;display:flex;flex-direction:column;gap:6px;flex:1}
    .nav a{padding:10px 12px;border-radius:12px;color:rgba(255,255,255,.86);display:flex;gap:10px;align-items:center}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .ico{width:18px;height:18px;border-radius:6px;display:inline-grid;place-items:center;background:rgba(255,255,255,.10);font-size:12px}
    .logout-btn{margin-top:auto;padding:10px 12px;border-radius:12px;color:rgba(255,255,255,.7);display:flex;gap:10px;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,.15);background:transparent;width:100%;font-size:14px;}
    .logout-btn:hover{background:rgba(255,0,0,.2);color:#fff}
    .main{flex:1;padding:26px 26px 40px}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .title h2{margin:0;font-size:28px}
    .title small{color:var(--muted)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid transparent;background:var(--primary);color:#fff;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;gap:8px;align-items:center;font-weight:600;}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--line);box-shadow:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .kpis{margin-top:18px;display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:14px}
    @media(max-width:1150px){.kpis{grid-template-columns:repeat(2,minmax(220px,1fr))}}
    @media(max-width:620px){.kpis{grid-template-columns:1fr}.sidebar{display:none}}
    .card{background:rgba(255,255,255,.86);border:1px solid var(--line);border-radius:var(--r);padding:14px 14px 16px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:12px;align-items:flex-start;}
    .stripe{position:absolute;left:0;top:0;bottom:0;width:5px}
    .cardIcon{width:46px;height:46px;border-radius:14px;background:rgba(111,76,255,.10);border:1px solid rgba(111,76,255,.18);display:grid;place-items:center;font-size:22px;flex:0 0 auto}
    .cardText{flex:1}
    .cardTitle{font-size:12px;letter-spacing:.02em;color:#3c3c52;text-transform:uppercase;margin:2px 0 6px;font-weight:700}
    .cardValue{font-size:28px;font-weight:900;margin:0}
    .cardHint{margin:4px 0 0;color:var(--muted);font-size:12px}
    .panel{margin-top:16px;background:rgba(255,255,255,.86);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .panelHeader{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);gap:10px;flex-wrap:wrap}
    .panelHeader h3{margin:0;font-size:18px}
    .search{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;min-width:260px;outline:none}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);font-size:13px;text-align:left;vertical-align:middle}
    th{background:rgba(111,76,255,.06);color:#4b4b63;font-weight:800}
    tbody tr:hover td{background:rgba(111,76,255,.035)}
    .nameCell{display:flex;align-items:center;gap:10px}
    .avatar{width:28px;height:28px;border-radius:999px;background:rgba(111,76,255,.18);border:1px solid rgba(111,76,255,.22);display:inline-grid;place-items:center;font-weight:800;color:#4b2fff}
    .badge{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700}
    .badge.active{background:rgba(16,185,129,.12);color:#065f46}
    .badge.inactive{background:rgba(239,68,68,.10);color:#991b1b}
    .actionBtns{display:flex;gap:6px;justify-content:flex-end}
    .toggleBtn{height:34px;border-radius:10px;border:1px solid;cursor:pointer;display:grid;place-items:center;padding:0 10px;font-size:12px;font-weight:700;}
    .toggleBtn.deactivate{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:var(--danger)}
    .toggleBtn.deactivate:hover{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.14)}
    .toggleBtn.reactivate{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08);color:#065f46}
    .toggleBtn.reactivate:hover{border-color:rgba(16,185,129,.6);background:rgba(16,185,129,.14)}
    .deleteBtn{height:34px;width:34px;border-radius:10px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.08);cursor:pointer;display:grid;place-items:center;font-size:15px;flex-shrink:0;}
    .deleteBtn:hover{border-color:rgba(239,68,68,.7);background:rgba(239,68,68,.18)}
    .tfoot{padding:10px 14px;display:flex;justify-content:flex-end;gap:8px;align-items:center;color:var(--muted);font-size:12px;background:rgba(255,255,255,.6)}
    .modal{position:fixed;inset:0;background:rgba(15,10,40,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .modal.open{display:flex}
    .box{width:min(900px,96vw);background:#fff;border-radius:18px;box-shadow:var(--shadow);border:1px solid var(--line);overflow:hidden}
    .boxBody{padding:18px 18px 16px}
    .boxHead{padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line)}
    .boxHead h4{margin:0;font-size:22px}
    .closeX{width:40px;height:36px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:820px){.grid2{grid-template-columns:1fr}}
    .field label{display:block;font-size:12px;color:#3c3c52;margin:0 0 6px;font-weight:800}
    .req{color:var(--danger);margin-left:3px}
    .field input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none;font-size:14px;background:#fff}
    .helper{margin:6px 0 0;color:var(--muted);font-size:12px}
    .inputWithIcon{position:relative}
    .iconBtn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;font-size:18px;opacity:.7}
    .iconBtn:hover{opacity:1}
    .infoBox{margin-top:14px;background:rgba(59,130,246,.10);border:1px solid rgba(59,130,246,.22);border-left:6px solid rgba(59,130,246,.65);padding:14px;border-radius:14px;color:#1f2a44}
    .actions{display:flex;justify-content:flex-end;gap:10px;padding:0 18px 18px}
    .error{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.25);color:#b91c1c;font-size:13px}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">âœ¦</div>
      <div><h1>Hawalina Ventures</h1><p>CEO Portal</p></div>
    </div>
    <nav class="nav">
      <a href="dashboard.html"><span class="ico">ğŸ§©</span>Dashboard</a>
      <a href="warehouse.html"><span class="ico">ğŸ“¦</span>Warehouse</a>
      <a href="products.html"><span class="ico">ğŸ§´</span>Products</a>
      <a class="active" href="agents.html"><span class="ico">ğŸ§‘ğŸ¾â€ğŸ’¼</span>Agents</a>
      <a href="distribute.html"><span class="ico">ğŸšš</span>Distribute Stock</a>
      <a href="sales.html"><span class="ico">ğŸ§¾</span>All Sales</a>
      <a href="payments.html"><span class="ico">ğŸ’³</span>Payments</a>
      <a href="stockbalance.html"><span class="ico">ğŸ“Š</span>Stock Balance</a>
      <a href="analytics.html"><span class="ico">ğŸ“ˆ</span>Analytics</a>
      <!-- <a href="settings.html"><span class="ico">âš™ï¸</span>Settings</a> -->
    </nav>
    <button class="logout-btn" id="logoutBtn">â‹ &nbsp;Logout</button>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <h2>Agent Management</h2>
        <small>Manage agents with National ID authentication</small>
      </div>
      <button class="btn" id="openModalBtn"><span style="font-size:18px;line-height:0">ï¼‹</span>Add New Agent</button>
    </div>

    <section class="kpis">
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#ffb86b,#6f4cff)"></span>
        <div class="cardIcon">ğŸ‘¥</div>
        <div class="cardText"><div class="cardTitle">TOTAL AGENTS</div><p class="cardValue" id="kpiAgents">0</p><p class="cardHint"><span id="kpiActive">0</span> active</p></div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#34d399,#10b981)"></span>
        <div class="cardIcon">ğŸ’°</div>
        <div class="cardText"><div class="cardTitle">OVERALL TOTAL COMMISSION</div><p class="cardValue">GHS <span id="kpiOverallComm">0</span></p><p class="cardHint">All time</p></div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#fbbf24,#f59e0b)"></span>
        <div class="cardIcon">ğŸ’±</div>
        <div class="cardText"><div class="cardTitle">TOP PERFORMER COMMISSION</div><p class="cardValue">GHS <span id="kpiTopComm">0</span></p><p class="cardHint">This month</p></div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#60a5fa,#3b82f6)"></span>
        <div class="cardIcon">ğŸ†</div>
        <div class="cardText"><div class="cardTitle">TOP PERFORMER</div><p class="cardValue" id="kpiTopName">-</p><p class="cardHint">This month</p></div>
      </div>
    </section>

    <section class="panel">
      <div class="panelHeader">
        <h3>ğŸ§‘ğŸ¾â€ğŸ’¼ All Agents</h3>
        <div><input class="search" id="search" placeholder="Search agents..." /></div>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:220px;">NAME</th>
              <th style="min-width:160px;">NATIONAL ID</th>
              <th style="min-width:150px;">PHONE</th>
              <th style="min-width:80px;">AGE</th>
              <th style="min-width:140px;">CITY</th>
              <th style="min-width:100px;">STATUS</th>
              <th style="min-width:160px;text-align:right;">ACTIONS</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" style="color:var(--muted);text-align:center;padding:18px">Loading agents...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tfoot"><span id="countLabel">0 agents</span></div>
    </section>
  </main>
</div>

<!-- Add Agent Modal -->
<div class="modal" id="modal">
  <div class="box" role="dialog" aria-modal="true">
    <div class="boxHead">
      <h4>â• Add New Agent</h4>
      <button class="closeX" id="closeModalBtn">Ã—</button>
    </div>
    <div class="boxBody">
      <div class="grid2">
        <div class="field" style="grid-column:1/-1;">
          <label for="f_nationalId">National ID <span class="req">*</span></label>
          <input id="f_nationalId" placeholder="GHA-123456789-0" />
          <div class="helper">Format: GHA-XXXXXXXXX-X</div>
        </div>
        <div class="field">
          <label for="f_fullName">Full Name <span class="req">*</span></label>
          <input id="f_fullName" placeholder="Sarah Mensah" />
        </div>
        <div class="field">
          <label for="f_phone">Phone <span class="req">*</span></label>
          <input id="f_phone" placeholder="+233 XX XXX XXXX" />
        </div>
        <div class="field">
          <label for="f_age">Age <span class="req">*</span></label>
          <input id="f_age" type="number" min="1" placeholder="e.g., 30" />
        </div>
        <div class="field">
          <label for="f_city">City <span class="req">*</span></label>
          <input id="f_city" placeholder="e.g., Kumasi" />
        </div>
        <div class="field">
          <label for="f_password">Password <span class="req">*</span></label>
          <div class="inputWithIcon">
            <input id="f_password" type="password" placeholder="Min 6 characters" />
            <button class="iconBtn" type="button" id="togglePw">ğŸ‘ï¸</button>
          </div>
          <div class="helper">Min 6 characters</div>
        </div>
        <div class="field">
          <label for="f_confirmPassword">Confirm Password <span class="req">*</span></label>
          <div class="inputWithIcon">
            <input id="f_confirmPassword" type="password" placeholder="Re-enter password" />
            <button class="iconBtn" type="button" id="togglePw2">ğŸ‘ï¸</button>
          </div>
        </div>
      </div>
      <div id="formError" class="error"></div>
      <div class="infoBox">
        <div style="font-weight:900;margin-bottom:6px;">ğŸ“Œ Login Instructions:</div>
        Agent will login using their <b>National ID</b> and the password you set here.
        Firebase login email: <b id="emailPreview">gha-xxxxxxxxx-x@agent.hawalina.com</b>
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="cancelBtn">Cancel</button>
      <button class="btn" id="createBtn">Create Agent</button>
    </div>
  </div>
</div>

<script type="module">
  import { logout, createAgentAccount, requireRole } from './auth.js';
  import { addAgent, getAllAgents, updateAgent, deleteAgent } from './firestore-db.js';

  let agents = [];

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const allowed = await requireRole('ceo');
    if (!allowed) return;
    setupPage();
    await loadAgents();
  }

  // â”€â”€ Page setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupPage() {
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await logout();
      window.location.href = 'index.html';
    });

    document.getElementById('search').addEventListener('input', render);

    const modal      = document.getElementById('modal');
    const closeModal = () => modal.classList.remove('open');

    document.getElementById('openModalBtn').addEventListener('click', () => {
      document.getElementById('formError').style.display = 'none';
      ['f_nationalId','f_fullName','f_phone','f_age','f_city','f_password','f_confirmPassword']
        .forEach(id => document.getElementById(id).value = '');
      document.getElementById('emailPreview').textContent = 'gha-xxxxxxxxx-x@agent.hawalina.com';
      modal.classList.add('open');
      setTimeout(() => document.getElementById('f_nationalId').focus(), 30);
    });

    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    document.getElementById('f_nationalId').addEventListener('input', e => {
      const val = e.target.value.trim();
      document.getElementById('emailPreview').textContent = val
        ? val.toLowerCase() + '@agent.hawalina.com'
        : 'gha-xxxxxxxxx-x@agent.hawalina.com';
    });

    document.getElementById('togglePw').addEventListener('click', () => {
      const el = document.getElementById('f_password');
      el.type = el.type === 'password' ? 'text' : 'password';
    });
    document.getElementById('togglePw2').addEventListener('click', () => {
      const el = document.getElementById('f_confirmPassword');
      el.type = el.type === 'password' ? 'text' : 'password';
    });

    document.getElementById('createBtn').addEventListener('click', async () => {
      document.getElementById('formError').style.display = 'none';

      const nationalId = document.getElementById('f_nationalId').value.trim();
      const fullName   = document.getElementById('f_fullName').value.trim();
      const phone      = document.getElementById('f_phone').value.trim();
      const age        = document.getElementById('f_age').value.trim();
      const city       = document.getElementById('f_city').value.trim();
      const password   = document.getElementById('f_password').value;
      const confirmPw  = document.getElementById('f_confirmPassword').value;

      if (!nationalId||!fullName||!phone||!age||!city||!password||!confirmPw)
        return showError('Please fill all required fields.');
      if (password.length < 6) return showError('Password must be at least 6 characters.');
      if (password !== confirmPw) return showError('Passwords do not match.');
      if (agents.some(a => (a.nationalId||'').toLowerCase() === nationalId.toLowerCase()))
        return showError('An agent with this National ID already exists.');

      const btn = document.getElementById('createBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Creating...';

      const authResult = await createAgentAccount(nationalId, password, { fullName, phone, age: Number(age), city, nationalId });
      if (!authResult.success) {
        btn.disabled = false; btn.textContent = 'Create Agent';
        return showError('Firebase Auth error: ' + authResult.error);
      }

      const dbResult = await addAgent({
        fullName, phone, age: Number(age), city, nationalId,
        firebaseUid: authResult.user.uid, isActive: true
      });

      btn.disabled = false; btn.textContent = 'Create Agent';
      if (!dbResult.success) return showError('Auth created but Firestore save failed: ' + dbResult.error);

      closeModal();
      await loadAgents();
    });
  }

  // â”€â”€ Load agents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadAgents() {
    document.getElementById('tbody').innerHTML =
      '<tr><td colspan="7" style="color:var(--muted);text-align:center;padding:18px">Loading agents...</td></tr>';
    const result = await getAllAgents();
    agents = result.success ? result.data : [];
    render();
    updateKPIs();
  }

  // â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateKPIs() {
    const active    = agents.filter(a => a.isActive !== false).length;
    const totalComm = agents.reduce((s, a) => s + (a.totalCommission || 0), 0);
    const top       = [...agents].sort((a,b) => (b.totalCommission||0)-(a.totalCommission||0))[0];
    document.getElementById('kpiAgents').textContent      = agents.length;
    document.getElementById('kpiActive').textContent      = active;
    document.getElementById('kpiOverallComm').textContent = totalComm.toLocaleString();
    document.getElementById('kpiTopComm').textContent     = top ? (top.totalCommission||0).toLocaleString() : '0';
    document.getElementById('kpiTopName').textContent     = top ? (top.fullName||top.name||'-') : '-';
  }

  // â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function render() {
    const q        = document.getElementById('search').value.trim().toLowerCase();
    const filtered = agents.filter(a =>
      `${a.fullName||a.name||''} ${a.nationalId||''} ${a.phone||''} ${a.city||''}`.toLowerCase().includes(q)
    );
    const tbody = document.getElementById('tbody');

    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="7" style="color:var(--muted);text-align:center;padding:18px">No agents found.</td></tr>';
      document.getElementById('countLabel').textContent = '0 agents';
      return;
    }

    tbody.innerHTML = filtered.map(a => {
      const name     = a.fullName || a.name || 'Unknown';
      const initials = name.split(' ').filter(Boolean).slice(0,2).map(s=>s[0].toUpperCase()).join('');
      const isActive = a.isActive !== false;
      return `<tr>
        <td><div class="nameCell">
          <span class="avatar">${initials}</span>
          <div style="font-weight:800">${esc(name)}</div>
        </div></td>
        <td>${esc(a.nationalId||'')}</td>
        <td>${esc(a.phone||'')}</td>
        <td>${esc(String(a.age||''))}</td>
        <td>${esc(a.city||'')}</td>
        <td><span class="badge ${isActive?'active':'inactive'}">${isActive?'â— Active':'â—‹ Inactive'}</span></td>
        <td>
          <div class="actionBtns">
            <button class="toggleBtn ${isActive?'deactivate':'reactivate'}"
              data-id="${a.id}" data-name="${esc(name)}" data-active="${isActive}"
              title="${isActive?'Deactivate agent':'Reactivate agent'}">
              ${isActive ? 'â¸ Deactivate' : 'â–¶ Reactivate'}
            </button>
            <button class="deleteBtn"
              data-id="${a.id}" data-name="${esc(name)}"
              title="Permanently delete agent">
              ğŸ—‘ï¸
            </button>
          </div>
        </td>
      </tr>`;
    }).join('');

    // Toggle handlers
    tbody.querySelectorAll('.toggleBtn').forEach(btn => {
      btn.addEventListener('click', () =>
        handleToggle(btn.dataset.id, btn.dataset.name, btn.dataset.active === 'true')
      );
    });

    // Delete handlers
    tbody.querySelectorAll('.deleteBtn').forEach(btn => {
      btn.addEventListener('click', () =>
        handleDelete(btn.dataset.id, btn.dataset.name)
      );
    });

    document.getElementById('countLabel').textContent = `${filtered.length} agent${filtered.length!==1?'s':''}`;
  }

  // â”€â”€ Toggle active/inactive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleToggle(agentId, agentName, isCurrentlyActive) {
    const action = isCurrentlyActive ? 'Deactivate' : 'Reactivate';
    if (!confirm(`${action} agent: ${agentName}?`)) return;
    const result = await updateAgent(agentId, { isActive: !isCurrentlyActive });
    if (result.success) {
      await loadAgents();
    } else {
      alert('Error updating agent: ' + result.error);
    }
  }

  // â”€â”€ Permanently delete agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleDelete(agentId, agentName) {
    // Double confirm for permanent action
    const first  = confirm(`Delete agent: ${agentName}?\n\nThis will permanently remove them from the system.`);
    if (!first) return;
    const second = confirm(`âš ï¸ Are you absolutely sure?\n\n"${agentName}" will be deleted permanently and cannot be recovered.`);
    if (!second) return;

    const result = await deleteAgent(agentId);
    if (result.success) {
      await loadAgents();
    } else {
      alert('Error deleting agent: ' + result.error);
    }
  }

  function showError(msg) {
    const el = document.getElementById('formError');
    el.textContent = msg; el.style.display = 'block';
  }
  function esc(str) {
    return String(str??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  init();
</script>
</body>
</html>
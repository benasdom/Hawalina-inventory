<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Commission ‚Ä¢ Hawalina Ventures</title>
  <style>
    :root{
      --primary:#6f4cff;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;--info:#3b82f6;
      --line:#ece7ff;--muted:#6b6b7a;--text:#1f1f2a;
      --shadow:0 8px 24px rgba(25,10,70,.08);--r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:radial-gradient(1100px 500px at 60% 0%,rgba(111,76,255,.12),transparent 55%),#f7f4ff;
    }
    a{text-decoration:none;color:inherit}
    .app{display:flex;min-height:100vh}
    .sidebar{width:250px;padding:20px 16px;background:linear-gradient(180deg,#1a0a3c,#120730);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;flex-shrink:0}
    .brand{display:flex;gap:10px;align-items:center;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:12px}
    .brandIcon{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px;flex-shrink:0}
    .brand h2{font-size:15px;margin:0;line-height:1.2}
    .brand p{margin:2px 0 0;color:rgba(255,255,255,.55);font-size:11px}
    .nav{display:flex;flex-direction:column;gap:3px;flex:1}
    .nav a{padding:9px 11px;border-radius:11px;color:rgba(255,255,255,.75);display:flex;gap:9px;align-items:center;font-size:13px;transition:background .15s}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .navIco{width:17px;height:17px;border-radius:5px;display:inline-grid;place-items:center;background:rgba(255,255,255,.1);font-size:10px;flex-shrink:0}
    .sideFooter{margin-top:auto;padding-top:14px;border-top:1px solid rgba(255,255,255,.1)}
    .agentMeta{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .agentAvatar{width:36px;height:36px;border-radius:11px;background:rgba(255,255,255,.14);display:grid;place-items:center;font-size:16px;flex-shrink:0}
    .agentName{font-weight:700;font-size:13px;margin:0;color:#fff}
    .agentId{color:rgba(255,255,255,.5);font-size:11px;margin:2px 0 0}
    .logoutBtn{width:100%;padding:9px 12px;border-radius:11px;border:1px solid rgba(255,255,255,.14);background:transparent;color:rgba(255,255,255,.65);cursor:pointer;font-size:12px;display:flex;gap:8px;align-items:center;justify-content:center}
    .logoutBtn:hover{background:rgba(220,50,50,.2);color:#fff}
    .main{flex:1;padding:28px 28px 60px;min-width:0}
    @media(max-width:640px){.sidebar{display:none}.main{padding:16px 14px 40px}}
    .topBar{margin-bottom:22px}
    .topBar h1{margin:0 0 4px;font-size:26px}
    .topBar p{margin:0;color:var(--muted);font-size:14px}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(155px,1fr));gap:13px;margin-bottom:20px}
    @media(max-width:1050px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.kpis{grid-template-columns:1fr}}
    .kpiCard{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);padding:15px 15px 17px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:11px;align-items:flex-start}
    .kpiCard::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px}
    .kpiCard.c-primary::before{background:linear-gradient(180deg,#6f4cff,#a78bfa)}
    .kpiCard.c-success::before{background:linear-gradient(180deg,#34d399,#10b981)}
    .kpiCard.c-warn::before{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
    .kpiCard.c-info::before{background:linear-gradient(180deg,#60a5fa,#3b82f6)}
    .kpiIco{width:44px;height:44px;border-radius:13px;background:rgba(111,76,255,.09);border:1px solid rgba(111,76,255,.16);display:grid;place-items:center;font-size:20px;flex-shrink:0}
    .kpiLabel{font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;font-weight:800;margin:0 0 5px}
    .kpiVal{font-size:21px;font-weight:900;margin:0 0 3px;color:var(--text)}
    .kpiHint{font-size:12px;color:var(--muted);margin:0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .panel{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px}
    .panelHead{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .panelHead h3{margin:0;font-size:15px}
    .panelHead .sub{font-size:12px;color:var(--muted)}
    .panelBody{padding:18px}
    .breakdownRow{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--line)}
    .breakdownRow:last-child{border-bottom:none}
    .breakdownLabel{font-size:13px;color:var(--muted);font-weight:600}
    .breakdownVal{font-size:15px;font-weight:900}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 13px;border-radius:20px;border:1.5px solid var(--line);background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:var(--muted)}
    .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .tableWrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead tr{background:rgba(111,76,255,.04)}
    th{padding:11px 14px;text-align:left;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;border-bottom:1px solid var(--line);white-space:nowrap}
    td{padding:11px 14px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover{background:rgba(111,76,255,.02)}
    .commVal{color:var(--success);font-weight:800}
    .prodRow{display:flex;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid var(--line)}
    .prodRow:last-child{border-bottom:none}
    .prodName{font-size:13px;font-weight:700;flex:1}
    .prodName small{color:var(--muted);font-weight:500;font-size:11px;display:block}
    .prodBar{flex:1;max-width:100px}
    .prodBarTrack{height:6px;border-radius:3px;background:rgba(111,76,255,.08);overflow:hidden}
    .prodBarFill{height:100%;border-radius:3px;background:linear-gradient(90deg,#6f4cff,#a78bfa)}
    .prodStat{font-size:12px;font-weight:800;color:var(--text);min-width:60px;text-align:right}
    .pagination{display:flex;gap:8px;align-items:center;padding:12px 18px;border-top:1px solid var(--line);font-size:13px;color:var(--muted)}
    .pgBtn{padding:6px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:var(--muted)}
    .pgBtn:hover:not(:disabled){border-color:var(--primary);color:var(--primary)}
    .pgBtn:disabled{opacity:.4;cursor:not-allowed}
    .empty{color:var(--muted);font-size:13px;text-align:center;padding:30px 0}
    .spinner{color:var(--muted);font-size:13px;text-align:center;padding:30px 0}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="brandIcon">‚ú¶</div>
      <div><h2>Hawalina Ventures</h2><p>Agent Portal</p></div>
    </div>
    <nav class="nav">
      <a href="agent-dashboard.html"><span class="navIco">üß©</span>Dashboard</a>
      <a href="agent-record-sale.html"><span class="navIco">üí∞</span>Record Sale</a>
      <a href="agent-sales.html"><span class="navIco">üìã</span>My Sales</a>
      <a href="agent-stock.html"><span class="navIco">üì¶</span>My Stock</a>
      <a class="active" href="agent-commission.html"><span class="navIco">üíµ</span>My Commission</a>
      <a href="agent-performance.html"><span class="navIco">üìà</span>Performance</a>
    </nav>
    <div class="sideFooter">
      <div class="agentMeta">
        <div class="agentAvatar">üë§</div>
        <div>
          <p class="agentName" id="sidebarName">Loading...</p>
          <p class="agentId"   id="sidebarId">‚Äî</p>
        </div>
      </div>
      <button class="logoutBtn" id="logoutBtn">üö™ &nbsp;Logout</button>
    </div>
  </aside>
  <main class="main">
    <div class="topBar">
      <h1>üíµ My Commission</h1>
      <p>Commission earned from your sales</p>
    </div>
    <div class="kpis">
      <div class="kpiCard c-primary">
        <div class="kpiIco">üí∞</div>
        <div><p class="kpiLabel">Total Earned</p><p class="kpiVal" id="kpiTotal">GHS ‚Äî</p><p class="kpiHint" id="kpiTotalHint">all time</p></div>
      </div>
      <div class="kpiCard c-success">
        <div class="kpiIco">üìÖ</div>
        <div><p class="kpiLabel">This Month</p><p class="kpiVal" id="kpiMonth">GHS ‚Äî</p><p class="kpiHint" id="kpiMonthHint">commission</p></div>
      </div>
      <div class="kpiCard c-warn">
        <div class="kpiIco">üìä</div>
        <div><p class="kpiLabel">Avg Per Sale</p><p class="kpiVal" id="kpiAvg">GHS ‚Äî</p><p class="kpiHint">per transaction</p></div>
      </div>
      <div class="kpiCard c-info">
        <div class="kpiIco">üìà</div>
        <div><p class="kpiLabel">Growth</p><p class="kpiVal" id="kpiGrowth">‚Äî</p><p class="kpiHint" id="kpiGrowthHint">vs last month</p></div>
      </div>
    </div>
    <div class="grid2">
      <div class="panel">
        <div class="panelHead"><h3>üí° Earnings Breakdown</h3></div>
        <div class="panelBody">
          <div class="breakdownRow"><span class="breakdownLabel">This month</span><span class="breakdownVal" style="color:var(--primary)" id="bdMonth">GHS ‚Äî</span></div>
          <div class="breakdownRow"><span class="breakdownLabel">Last month</span><span class="breakdownVal" style="color:var(--muted)" id="bdLastMonth">GHS ‚Äî</span></div>
          <div class="breakdownRow"><span class="breakdownLabel">This year</span><span class="breakdownVal" style="color:var(--info)" id="bdYear">GHS ‚Äî</span></div>
          <div class="breakdownRow" style="border-top:2px solid var(--line);margin-top:4px">
            <span class="breakdownLabel" style="color:var(--text);font-weight:800">All-time total</span>
            <span class="breakdownVal" style="font-size:18px;color:var(--primary)" id="bdTotal">GHS ‚Äî</span>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panelHead"><h3>üì¶ Top Products by Commission</h3><span class="sub">All time</span></div>
        <div class="panelBody" id="topProducts"><p class="spinner">Loading‚Ä¶</p></div>
      </div>
    </div>
    <div class="panel">
      <div class="panelHead">
        <h3>üìã Commission History</h3>
        <div class="chips">
          <button class="chip active" data-period="all">All Time</button>
          <button class="chip" data-period="7">7 Days</button>
          <button class="chip" data-period="30">30 Days</button>
          <button class="chip" data-period="month">This Month</button>
        </div>
      </div>
      <div class="tableWrap">
        <table>
          <thead><tr>
            <th>Date</th><th>Customer</th><th>Product</th>
            <th>Qty</th><th>Sale Value</th><th>Commission</th>
          </tr></thead>
          <tbody id="historyBody"><tr><td colspan="6" class="spinner">Loading‚Ä¶</td></tr></tbody>
        </table>
      </div>
      <div class="pagination">
        <button class="pgBtn" id="pgPrev" disabled>‚Üê Prev</button>
        <span id="pgInfo">‚Äî</span>
        <button class="pgBtn" id="pgNext" disabled>Next ‚Üí</button>
      </div>
    </div>
  </main>
</div>
<script type="module">
  import { requireRole, logout, onAuthChange } from './auth.js';
  import { getAllAgents, getSales } from './firestore-db.js';

  let sales = [], filtered = [], activePeriod = 'all', page = 0;
  const PAGE_SIZE = 20;

  async function init() {
    const allowed = await requireRole('agent');
    if (!allowed) return;

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) { await logout(); window.location.href = 'index.html'; }
    });

    document.querySelectorAll('.chip[data-period]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chip[data-period]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activePeriod = btn.dataset.period; page = 0; applyFilter();
      });
    });

    document.getElementById('pgPrev').addEventListener('click', () => { page--; renderTable(); });
    document.getElementById('pgNext').addEventListener('click', () => { page++; renderTable(); });

    onAuthChange(async (user) => {
      if (!user) return;

      let match = null;
      for (let attempt = 1; attempt <= 3; attempt++) {
        const allRes = await getAllAgents();
        if (allRes.success && allRes.data.length > 0) {
          match = allRes.data.find(a => a.firebaseUid === user.uid);
          if (match) break;
        }
        if (attempt < 3) await new Promise(r => setTimeout(r, attempt * 800));
      }
      if (!match) {
        document.getElementById('sidebarName').textContent = 'Profile error';
        document.getElementById('sidebarId').textContent   = 'Contact admin';
        console.warn('Agent profile not found for uid:', user.uid);
        return;
      }

      document.getElementById('sidebarName').textContent = match.fullName || match.name || 'Agent';
      document.getElementById('sidebarId').textContent   = match.nationalId || '‚Äî';

      const salesRes = await getSales(match.id);
      sales = salesRes.success ? salesRes.data : [];
      applyFilter(); renderBreakdown(); renderTopProducts();
    });
  }

  function applyFilter() {
    const now = new Date();
    const ms  = new Date(now.getFullYear(), now.getMonth(), 1);
    filtered = sales.filter(s => {
      if (activePeriod === 'all') return true;
      const d = toDate(s.saleDate); if (!d) return false;
      if (activePeriod === 'month') return d >= ms;
      const c = new Date(now); c.setDate(now.getDate() - parseInt(activePeriod)); return d >= c;
    }).sort((a, b) => (toDate(b.saleDate)||0) - (toDate(a.saleDate)||0));
    page = 0; renderKPIs(); renderTable();
  }

  function renderKPIs() {
    const now = new Date();
    const ms  = new Date(now.getFullYear(), now.getMonth(), 1);
    const me  = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    const ls  = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const le  = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
    const total = sales.reduce((s, d) => s + (d.agentCommission || 0), 0);
    const thisM = sales.filter(s => inRange(toDate(s.saleDate), ms, me)).reduce((s, d) => s + (d.agentCommission || 0), 0);
    const lastM = sales.filter(s => inRange(toDate(s.saleDate), ls, le)).reduce((s, d) => s + (d.agentCommission || 0), 0);
    const avg   = sales.length ? total / sales.length : 0;
    const growth = lastM > 0 ? ((thisM - lastM) / lastM * 100) : null;

    document.getElementById('kpiTotal').textContent     = 'GHS ' + fmt(total);
    document.getElementById('kpiTotalHint').textContent = sales.length + ' total sales';
    document.getElementById('kpiMonth').textContent     = 'GHS ' + fmt(thisM);
    document.getElementById('kpiMonthHint').textContent = sales.filter(s => inRange(toDate(s.saleDate), ms, me)).length + ' sales this month';
    document.getElementById('kpiAvg').textContent       = 'GHS ' + fmt(avg);
    if (growth !== null) {
      document.getElementById('kpiGrowth').textContent   = (growth >= 0 ? '+' : '') + growth.toFixed(1) + '%';
      document.getElementById('kpiGrowth').style.color   = growth >= 0 ? 'var(--success)' : 'var(--danger)';
      document.getElementById('kpiGrowthHint').textContent = 'vs last month';
    } else {
      document.getElementById('kpiGrowth').textContent     = '‚Äî';
      document.getElementById('kpiGrowth').style.color     = 'var(--muted)';
      document.getElementById('kpiGrowthHint').textContent = 'no data last month';
    }
  }

  function renderBreakdown() {
    const now  = new Date();
    const ms   = new Date(now.getFullYear(), now.getMonth(), 1);
    const me   = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    const ls   = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const le   = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
    const ys   = new Date(now.getFullYear(), 0, 1);
    const total  = sales.reduce((s, d) => s + (d.agentCommission || 0), 0);
    const thisM  = sales.filter(s => inRange(toDate(s.saleDate), ms, me)).reduce((s, d) => s + (d.agentCommission || 0), 0);
    const lastM  = sales.filter(s => inRange(toDate(s.saleDate), ls, le)).reduce((s, d) => s + (d.agentCommission || 0), 0);
    const year   = sales.filter(s => { const d = toDate(s.saleDate); return d && d >= ys; }).reduce((s, d) => s + (d.agentCommission || 0), 0);
    document.getElementById('bdMonth').textContent     = 'GHS ' + fmt(thisM);
    document.getElementById('bdLastMonth').textContent = 'GHS ' + fmt(lastM);
    document.getElementById('bdYear').textContent      = 'GHS ' + fmt(year);
    document.getElementById('bdTotal').textContent     = 'GHS ' + fmt(total);
  }

  function renderTopProducts() {
    const el = document.getElementById('topProducts');
    const map = {};
    sales.forEach(s => {
      const key = [s.hairBrand || s.brand, s.color, s.length ? s.length+'"' : ''].filter(Boolean).join(' ') || '‚Äî';
      if (!map[key]) map[key] = { comm: 0, units: 0 };
      map[key].comm  += (s.agentCommission || 0);
      map[key].units += (s.quantity || 1);
    });
    const sorted = Object.entries(map).sort((a, b) => b[1].comm - a[1].comm).slice(0, 6);
    if (!sorted.length) { el.innerHTML = '<p class="empty">No sales yet.</p>'; return; }
    const maxComm = sorted[0][1].comm || 1;
    el.innerHTML = sorted.map(([name, info]) => {
      const pct = Math.round((info.comm / maxComm) * 100);
      return '<div class="prodRow"><div class="prodName">' + esc(name) + '<small>' + info.units + ' unit' + (info.units!==1?'s':'') + ' sold</small></div>'
        + '<div class="prodBar"><div class="prodBarTrack"><div class="prodBarFill" style="width:' + pct + '%"></div></div></div>'
        + '<div class="prodStat">GHS ' + fmt(info.comm, 0) + '</div></div>';
    }).join('');
  }

  function renderTable() {
    const body  = document.getElementById('historyBody');
    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    page = Math.min(page, pages - 1);
    const slice = filtered.slice(page * PAGE_SIZE, (page + 1) * PAGE_SIZE);
    document.getElementById('pgInfo').textContent = (total === 0 ? 0 : page * PAGE_SIZE + 1) + '‚Äì' + Math.min((page+1)*PAGE_SIZE, total) + ' of ' + total;
    document.getElementById('pgPrev').disabled    = page === 0;
    document.getElementById('pgNext').disabled    = page >= pages - 1;
    if (!slice.length) { body.innerHTML = '<tr><td colspan="6" class="empty">No sales in this period.</td></tr>'; return; }
    body.innerHTML = slice.map(s => {
      const d    = toDate(s.saleDate);
      const ds   = d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) : '‚Äî';
      const prod = [s.hairBrand || s.brand, s.color, s.length ? s.length+'"' : ''].filter(Boolean).join(' ') || '‚Äî';
      return '<tr><td style="color:var(--muted);white-space:nowrap">' + ds + '</td>'
        + '<td><strong>' + esc(s.customerName || s.customer || '‚Äî') + '</strong></td>'
        + '<td>' + esc(prod) + '</td>'
        + '<td style="text-align:center">' + (s.quantity||1) + '</td>'
        + '<td>GHS ' + fmt(s.totalSellingPrice||0) + '</td>'
        + '<td><strong class="commVal">GHS ' + fmt(s.agentCommission||0) + '</strong></td></tr>';
    }).join('');
  }

  function toDate(val) {
    if (!val) return null;
    if (val.toDate) return val.toDate();
    if (val.seconds) return new Date(val.seconds * 1000);
    return new Date(val);
  }
  function inRange(d, s, e) { return d && d >= s && d <= e; }
  function fmt(n, dp=2) { return Number(n||0).toLocaleString('en-GH', { minimumFractionDigits:dp, maximumFractionDigits:dp }); }
  function esc(str) { return String(str??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  init();
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Distribute Stock ‚Ä¢ Hawalina Ventures</title>
  <style>
    :root{
      --bg:#f7f4ff;--text:#1f1f2a;--muted:#6b6b7a;--primary:#6f4cff;
      --line:#ece7ff;--shadow:0 10px 25px rgba(25,10,70,.08);--r:18px;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 70% 0%,rgba(111,76,255,.22),transparent 55%),
        radial-gradient(900px 500px at 0% 30%,rgba(139,107,255,.14),transparent 60%),
        var(--bg);
    }
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;padding:22px 18px;background:linear-gradient(180deg,#24134f,#1a1036);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;}
    .brand{display:flex;gap:12px;align-items:center;padding:10px 10px 18px}
    .logo{width:46px;height:46px;border-radius:16px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px}
    .brand h1{font-size:18px;margin:0;line-height:1.1}
    .brand p{margin:4px 0 0;color:rgba(255,255,255,.7);font-size:12px}
    .nav{margin-top:10px;display:flex;flex-direction:column;gap:6px;flex:1}
    .nav a{padding:10px 12px;border-radius:12px;color:rgba(255,255,255,.86);display:flex;gap:10px;align-items:center}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .ico{width:18px;height:18px;border-radius:6px;display:inline-grid;place-items:center;background:rgba(255,255,255,.10);font-size:12px}
    .logout-btn{margin-top:auto;padding:10px 12px;border-radius:12px;color:rgba(255,255,255,.7);display:flex;gap:10px;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,.15);background:transparent;width:100%;font-size:14px;}
    .logout-btn:hover{background:rgba(255,0,0,.2);color:#fff}
    .main{flex:1;padding:26px 26px 40px}
    @media(max-width:620px){.sidebar{display:none}}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .titleWrap{display:flex;gap:10px;align-items:flex-start}
    .pageIcon{width:42px;height:42px;border-radius:14px;background:rgba(111,76,255,.12);border:1px solid rgba(111,76,255,.18);display:grid;place-items:center;font-size:20px;margin-top:2px}
    .title h2{margin:0;font-size:30px}
    .title small{color:var(--muted);display:block;margin-top:4px}
    .kpis{margin-top:16px;display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:14px}
    @media(max-width:1150px){.kpis{grid-template-columns:repeat(2,minmax(200px,1fr))}}
    @media(max-width:620px){.kpis{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.86);border:1px solid var(--line);border-radius:var(--r);padding:14px 14px 16px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:12px;align-items:flex-start;}
    .stripe{position:absolute;left:0;top:0;bottom:0;width:5px}
    .cardIcon{width:46px;height:46px;border-radius:14px;background:rgba(111,76,255,.10);border:1px solid rgba(111,76,255,.18);display:grid;place-items:center;font-size:22px;flex:0 0 auto}
    .cardText{flex:1}
    .cardTitle{font-size:12px;letter-spacing:.02em;color:#3c3c52;text-transform:uppercase;margin:2px 0 6px;font-weight:900}
    .cardValue{font-size:26px;font-weight:900;margin:0}
    .cardHint{margin:4px 0 0;color:var(--muted);font-size:12px}
    .panel{margin-top:16px;background:rgba(255,255,255,.86);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .panelHeader{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);gap:10px;flex-wrap:wrap}
    .panelHeader h3{margin:0;font-size:18px}
    .search{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;min-width:240px;outline:none}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);font-size:13px;text-align:left;vertical-align:middle;white-space:nowrap}
    th{background:rgba(111,76,255,.06);color:#4b4b63;font-weight:900}
    tbody tr:hover td{background:rgba(111,76,255,.035)}
    .tfoot{padding:10px 14px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.6)}
    .empty{text-align:center;color:var(--muted);padding:20px 10px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid transparent;background:var(--primary);color:#fff;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;gap:8px;align-items:center;font-weight:700;}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--line);box-shadow:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .addBtn{padding:12px 16px;border-radius:12px;border:1px solid rgba(111,76,255,.35);background:rgba(111,76,255,.10);cursor:pointer;display:inline-flex;gap:10px;align-items:center;font-weight:900;color:var(--primary);font-size:15px;}
    .addBtn:hover{background:rgba(111,76,255,.18)}
    .modal{position:fixed;inset:0;background:rgba(15,10,40,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .modal.open{display:flex}
    .box{width:min(1000px,96vw);background:#fff;border-radius:18px;box-shadow:var(--shadow);border:1px solid var(--line);overflow:hidden;max-height:92vh;overflow-y:auto}
    .boxHead{padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);position:sticky;top:0;background:#fff;z-index:2}
    .boxHead h4{margin:0;font-size:22px}
    .closeX{width:40px;height:36px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:18px}
    .boxBody{padding:18px 18px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:820px){.grid2{grid-template-columns:1fr}}
    .sectionTitle{font-weight:900;color:#2b2b3c;margin:0 0 10px;font-size:15px}
    .field label{display:block;font-size:12px;color:#3c3c52;margin:0 0 6px;font-weight:900}
    .req{color:var(--danger);margin-left:3px}
    .field input,.field select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none;font-size:14px;background:#fff}
    .field input:focus,.field select:focus{border-color:var(--primary)}
    .helper{margin:6px 0 0;color:var(--muted);font-size:12px}
    .readonlyField{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:14px;background:rgba(111,76,255,.05);font-weight:700;color:var(--primary)}
    .summaryRow{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:820px){.summaryRow{grid-template-columns:1fr}}
    .sumCard{background:rgba(111,76,255,.05);border:1px solid var(--line);border-radius:14px;padding:14px}
    .sumCard h5{margin:0 0 8px;font-size:13px;color:var(--muted);font-weight:700}
    .sumCard .big{font-size:28px;font-weight:900;margin:0 0 4px;color:var(--text)}
    .sumCard .mini{color:var(--muted);font-size:12px;margin:0}
    .form-error{display:none;margin:8px 18px 0;padding:10px 12px;border-radius:12px;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.25);color:#b91c1c;font-size:13px}
    .actions{display:flex;justify-content:flex-end;gap:10px;padding:14px 18px 18px}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">‚ú¶</div>
      <div><h1>Hawalina Ventures</h1><p>CEO Portal</p></div>
    </div>
    <nav class="nav">
      <a href="dashboard.html"><span class="ico">üß©</span>Dashboard</a>
      <a href="warehouse.html"><span class="ico">üì¶</span>Warehouse</a>
      <a href="products.html"><span class="ico">üß¥</span>Products</a>
      <a href="agents.html"><span class="ico">üßëüèæ‚Äçüíº</span>Agents</a>
      <a class="active" href="distribute.html"><span class="ico">üöö</span>Distribute Stock</a>
      <a href="sales.html"><span class="ico">üßæ</span>All Sales</a>
      <a href="payments.html"><span class="ico">üí≥</span>Payments</a>
      <a href="stockbalance.html"><span class="ico">üìä</span>Stock Balance</a>
      <a href="analytics.html"><span class="ico">üìà</span>Analytics</a>
      <a href="settings.html"><span class="ico">‚öôÔ∏è</span>Settings</a>
    </nav>
    <button class="logout-btn" id="logoutBtn">‚éã &nbsp;Logout</button>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="titleWrap">
        <div class="pageIcon">üöö</div>
        <div class="title">
          <h2>Distribute Stock</h2>
          <small>Distribute warehouse stock to agents</small>
        </div>
      </div>
      <button class="addBtn" id="openModalBtn">Ôºã Add New Distribution</button>
    </div>

    <section class="kpis">
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#fbbf24,#f59e0b)"></span>
        <div class="cardIcon">üí∞</div>
        <div class="cardText">
          <div class="cardTitle">TOTAL AGENT PRICE</div>
          <p class="cardValue">GHS <span id="kpiAgent">0</span></p>
          <p class="cardHint">Total owed by all agents</p>
        </div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#34d399,#10b981)"></span>
        <div class="cardIcon">üíµ</div>
        <div class="cardText">
          <div class="cardTitle">TOTAL SELLING PRICE</div>
          <p class="cardValue">GHS <span id="kpiSell">0</span></p>
          <p class="cardHint">Expected revenue if all sold</p>
        </div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#60a5fa,#3b82f6)"></span>
        <div class="cardIcon">üìä</div>
        <div class="cardText">
          <div class="cardTitle">TOTAL COMMISSION</div>
          <p class="cardValue">GHS <span id="kpiComm">0</span></p>
          <p class="cardHint">Selling price ‚àí Agent price</p>
        </div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#ffb86b,#6f4cff)"></span>
        <div class="cardIcon">üì¶</div>
        <div class="cardText">
          <div class="cardTitle">TOTAL UNITS DISTRIBUTED</div>
          <p class="cardValue"><span id="kpiDist">0</span> <span style="font-size:.5em">units</span></p>
          <p class="cardHint">Across all distributions</p>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panelHeader">
        <h3>üöö Distribution Records</h3>
        <input class="search" id="search" placeholder="Search by agent, brand, color..." />
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>DATE</th><th>AGENT</th><th>BRAND</th><th>COLOR</th><th>LENGTH</th>
              <th>QTY</th><th>UNIT AGENT PRICE</th><th>UNIT SELLING PRICE</th>
              <th>TOTAL AGENT PRICE</th><th>COMMISSION</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" class="empty">Loading distributions...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tfoot"><span id="countLabel">0 records</span></div>
    </section>
  </main>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="box" role="dialog" aria-modal="true">
    <div class="boxHead">
      <h4>Ôºã Add New Distribution</h4>
      <button class="closeX" id="closeModalBtn">√ó</button>
    </div>
    <div class="form-error" id="formError"></div>
    <div class="boxBody">
      <p class="sectionTitle">Distribution Details</p>
      <div class="grid2">
        <div class="field">
          <label>Date <span class="req">*</span></label>
          <input type="date" id="f_date" />
        </div>
        <div class="field">
          <label>Agent <span class="req">*</span></label>
          <select id="f_agent"><option value="">Select Agent</option></select>
        </div>
        <div class="field">
          <label>Brand <span class="req">*</span></label>
          <select id="f_brand"><option value="">Select Brand</option></select>
        </div>
        <div class="field">
          <label>Color <span class="req">*</span></label>
          <select id="f_color" disabled><option value="">Select brand first</option></select>
        </div>
        <div class="field">
          <label>Length (Inches) <span class="req">*</span></label>
          <select id="f_length" disabled><option value="">Select color first</option></select>
        </div>
        <div class="field">
          <label>Warehouse Stock Batch <span class="req">*</span></label>
          <select id="f_warehouseItem" disabled><option value="">Select length first</option></select>
          <div class="helper" id="availableHint"></div>
        </div>
        <div class="field">
          <label>Quantity to Distribute <span class="req">*</span></label>
          <input type="number" id="f_qty" min="1" placeholder="e.g., 10" />
        </div>
        <div class="field">
          <label>Unit Agent Price (GHS) <span class="req">*</span></label>
          <input type="number" id="f_unitAgent" min="0" step="0.01" placeholder="e.g., 120" />
          <div class="helper">Price the agent pays per unit</div>
        </div>
        <div class="field">
          <label>Unit Selling Price (GHS)</label>
          <div class="readonlyField" id="f_unitSell">‚Äî</div>
          <div class="helper">Auto-filled from Product Catalog</div>
        </div>
        <div class="field">
          <label>Notes</label>
          <input type="text" id="f_notes" placeholder="Optional notes..." />
        </div>
      </div>

      <p class="sectionTitle" style="margin-top:18px">Summary</p>
      <div class="summaryRow">
        <div class="sumCard">
          <h5>Total Agent Price</h5>
          <p class="big">GHS <span id="sumAgent">0.00</span></p>
          <p class="mini">Qty √ó Unit Agent Price</p>
        </div>
        <div class="sumCard">
          <h5>Total Selling Price</h5>
          <p class="big">GHS <span id="sumSell">0.00</span></p>
          <p class="mini">Qty √ó Unit Selling Price</p>
        </div>
        <div class="sumCard">
          <h5>Expected Commission</h5>
          <p class="big">GHS <span id="sumComm">0.00</span></p>
          <p class="mini">Total Selling ‚àí Total Agent</p>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="cancelBtn">Cancel</button>
      <button class="btn" id="addBtn">Add Distribution</button>
    </div>
  </div>
</div>

<script type="module">
  import { requireRole, logout } from './auth.js';
  import {
    getAllAgents, getHairBrands, getColorsByBrand,
    getLengthsByBrandAndColor, getWarehouseStock,
    addDistribution, getDistributions, getAllProducts
  } from './firestore-db.js';

  let distributions = [], agents = [], warehouseStock = [], products = [];
  let selectedWarehouseItem = null, sellingPrice = 0;

  // ‚îÄ‚îÄ Auth guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init() {
    const allowed = await requireRole('ceo');
    if (!allowed) return;
    setupListeners();
    await loadPage();
  }

  async function loadPage() {
    const [distRes, agentRes, whRes, prodRes] = await Promise.all([
      getDistributions(), getAllAgents(), getWarehouseStock(), getAllProducts()
    ]);
    distributions  = distRes.success  ? distRes.data  : [];
    agents         = agentRes.success ? agentRes.data.filter(a => a.isActive !== false) : [];
    warehouseStock = whRes.success    ? whRes.data    : [];
    products       = prodRes.success  ? prodRes.data  : [];
    renderTable(distributions);
    updateKPIs(distributions);
  }

  // ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateKPIs(dists) {
    let ta = 0, ts = 0, units = 0;
    dists.forEach(d => {
      ta    += d.totalAgentPrice   || 0;
      ts    += d.totalSellingPrice || 0;
      units += d.quantity          || 0;
    });
    document.getElementById('kpiAgent').textContent = fmt(ta);
    document.getElementById('kpiSell').textContent  = fmt(ts);
    document.getElementById('kpiComm').textContent  = fmt(ts - ta);
    document.getElementById('kpiDist').textContent  = units;
  }

  // ‚îÄ‚îÄ Render table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderTable(dists) {
    const q        = document.getElementById('search').value.trim().toLowerCase();
    const filtered = dists.filter(d =>
      `${d.agentName||''} ${d.hairBrand||''} ${d.color||''} ${d.length||''}`.toLowerCase().includes(q)
    );
    const tbody = document.getElementById('tbody');
    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="10" class="empty">No distribution records found.</td></tr>';
      document.getElementById('countLabel').textContent = '0 records';
      return;
    }
    tbody.innerHTML = filtered.map(d => {
      const tSell = d.totalSellingPrice || 0;
      const tAgent = d.totalAgentPrice  || 0;
      return `<tr>
        <td>${esc(toDateStr(d.distributionDate))}</td>
        <td>${esc(d.agentName||'‚Äî')}</td>
        <td>${esc(d.hairBrand||'‚Äî')}</td>
        <td>${esc(d.color||'‚Äî')}</td>
        <td>${esc(String(d.length||'‚Äî'))}"</td>
        <td>${d.quantity||0}</td>
        <td>GHS ${fmt(d.unitAgentPrice)}</td>
        <td>GHS ${fmt(d.unitSellingPrice)}</td>
        <td>GHS ${fmt(tAgent)}</td>
        <td>GHS ${fmt(tSell - tAgent)}</td>
      </tr>`;
    }).join('');
    document.getElementById('countLabel').textContent =
      `${filtered.length} record${filtered.length!==1?'s':''}`;
  }

  // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const modal = document.getElementById('modal');

  async function openModal() {
    document.getElementById('formError').style.display = 'none';
    document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('f_qty').value = '';
    document.getElementById('f_unitAgent').value = '';
    document.getElementById('f_unitSell').textContent = '‚Äî';
    document.getElementById('f_notes').value = '';
    document.getElementById('f_color').disabled = true;
    document.getElementById('f_color').innerHTML = '<option value="">Select brand first</option>';
    document.getElementById('f_length').disabled = true;
    document.getElementById('f_length').innerHTML = '<option value="">Select color first</option>';
    document.getElementById('f_warehouseItem').disabled = true;
    document.getElementById('f_warehouseItem').innerHTML = '<option value="">Select length first</option>';
    document.getElementById('availableHint').textContent = '';
    selectedWarehouseItem = null; sellingPrice = 0; updateSummary();

    // Agents
    const agSel = document.getElementById('f_agent');
    agSel.innerHTML = '<option value="">Select Agent</option>';
    agents.forEach(a =>
      agSel.innerHTML += `<option value="${a.id}" data-name="${esc(a.fullName||a.name||'')}">${esc(a.fullName||a.name||'Unknown')}</option>`
    );

    // Brands from catalog
    const bSel = document.getElementById('f_brand');
    bSel.innerHTML = '<option value="">Select Brand</option>';
    const bRes = await getHairBrands();
    (bRes.success ? bRes.data : []).forEach(b =>
      bSel.innerHTML += `<option value="${esc(b)}">${esc(b)}</option>`
    );

    modal.classList.add('open');
  }

  const closeModal = () => modal.classList.remove('open');

  // ‚îÄ‚îÄ Cascading dropdowns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('f_brand').addEventListener('change', async function() {
    const brand = this.value;
    const cSel  = document.getElementById('f_color');
    const lSel  = document.getElementById('f_length');
    const wSel  = document.getElementById('f_warehouseItem');
    cSel.innerHTML = '<option value="">Select Color</option>';
    lSel.innerHTML = '<option value="">Select color first</option>';
    wSel.innerHTML = '<option value="">Select length first</option>';
    cSel.disabled = !brand; lSel.disabled = true; wSel.disabled = true;
    document.getElementById('f_unitSell').textContent = '‚Äî';
    selectedWarehouseItem = null; sellingPrice = 0; updateSummary();
    if (!brand) return;
    const res = await getColorsByBrand(brand);
    (res.success ? res.data : []).forEach(c =>
      cSel.innerHTML += `<option value="${esc(c)}">${esc(c)}</option>`
    );
  });

  document.getElementById('f_color').addEventListener('change', async function() {
    const brand = document.getElementById('f_brand').value;
    const color = this.value;
    const lSel  = document.getElementById('f_length');
    const wSel  = document.getElementById('f_warehouseItem');
    lSel.innerHTML = '<option value="">Select Length</option>';
    wSel.innerHTML = '<option value="">Select length first</option>';
    lSel.disabled = !color; wSel.disabled = true;
    document.getElementById('f_unitSell').textContent = '‚Äî';
    selectedWarehouseItem = null; sellingPrice = 0; updateSummary();
    if (!brand || !color) return;
    const res = await getLengthsByBrandAndColor(brand, color);
    (res.success ? res.data : []).forEach(l =>
      lSel.innerHTML += `<option value="${l}">${l} inches</option>`
    );
  });

  document.getElementById('f_length').addEventListener('change', function() {
    const brand  = document.getElementById('f_brand').value;
    const color  = document.getElementById('f_color').value;
    const length = this.value;
    const wSel   = document.getElementById('f_warehouseItem');
    wSel.innerHTML = '<option value="">Select batch</option>';
    wSel.disabled  = !length;
    selectedWarehouseItem = null; sellingPrice = 0;
    document.getElementById('f_unitSell').textContent = '‚Äî';
    document.getElementById('availableHint').textContent = '';
    updateSummary();
    if (!brand || !color || !length) return;

    // Available warehouse batches
    const batches = warehouseStock.filter(w =>
      w.hairBrand === brand && w.color === color &&
      String(w.length) === String(length) && w.availableQuantity > 0
    );
    if (!batches.length) {
      wSel.innerHTML = '<option value="">No available stock for this product</option>';
    } else {
      batches.forEach(w =>
        wSel.innerHTML += `<option value="${w.id}">
          ${w.importDate||'N/A'} ‚Äî ${w.availableQuantity} units @ GHS ${fmt(w.importPrice)}/unit
        </option>`
      );
    }

    // Auto-fill selling price from catalog
    const prod = products.find(p =>
      p.hairBrand === brand && p.color === color && String(p.length) === String(length)
    );
    if (prod && prod.sellingPrice) {
      sellingPrice = prod.sellingPrice;
      document.getElementById('f_unitSell').textContent = 'GHS ' + fmt(sellingPrice);
    }
    updateSummary();
  });

  document.getElementById('f_warehouseItem').addEventListener('change', function() {
    selectedWarehouseItem = warehouseStock.find(w => w.id === this.value) || null;
    document.getElementById('availableHint').textContent = selectedWarehouseItem
      ? `‚úÖ ${selectedWarehouseItem.availableQuantity} units available in this batch`
      : '';
  });

  // ‚îÄ‚îÄ Live summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ['f_qty','f_unitAgent'].forEach(id =>
    document.getElementById(id).addEventListener('input', updateSummary)
  );

  function updateSummary() {
    const qty   = parseFloat(document.getElementById('f_qty').value)       || 0;
    const ua    = parseFloat(document.getElementById('f_unitAgent').value) || 0;
    const tA    = qty * ua;
    const tS    = qty * sellingPrice;
    document.getElementById('sumAgent').textContent = fmt(tA);
    document.getElementById('sumSell').textContent  = fmt(tS);
    document.getElementById('sumComm').textContent  = fmt(tS - tA);
  }

  // ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('addBtn').addEventListener('click', async () => {
    document.getElementById('formError').style.display = 'none';

    const agSel     = document.getElementById('f_agent');
    const agentId   = agSel.value;
    const agentName = agSel.options[agSel.selectedIndex]?.dataset?.name || '';
    const brand     = document.getElementById('f_brand').value;
    const color     = document.getElementById('f_color').value;
    const length    = document.getElementById('f_length').value;
    const date      = document.getElementById('f_date').value;
    const qty       = parseInt(document.getElementById('f_qty').value);
    const unitAgent = parseFloat(document.getElementById('f_unitAgent').value);
    const notes     = document.getElementById('f_notes').value.trim();

    if (!agentId)              return showErr('Please select an agent.');
    if (!brand||!color||!length) return showErr('Please select brand, color and length.');
    if (!selectedWarehouseItem) return showErr('Please select a warehouse stock batch.');
    if (!qty || qty < 1)        return showErr('Quantity must be at least 1.');
    if (qty > selectedWarehouseItem.availableQuantity)
      return showErr(`Only ${selectedWarehouseItem.availableQuantity} units available in this batch.`);
    if (!unitAgent || unitAgent < 0) return showErr('Please enter a valid unit agent price.');

    const btn = document.getElementById('addBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';

    const totalAgentPrice   = qty * unitAgent;
    const totalSellingPrice = qty * sellingPrice;

    const result = await addDistribution({
      agentId,
      agentName,
      hairBrand:        brand,
      color,
      length:           Number(length),
      quantity:         qty,
      unitAgentPrice:   unitAgent,
      unitSellingPrice: sellingPrice,
      totalAgentPrice,
      totalSellingPrice,
      agentCommission:  totalSellingPrice - totalAgentPrice,
      warehouseStockId: selectedWarehouseItem.id,
      notes,
      distributionDate: date,
      items: [{
        hairBrand:        brand,
        color,
        length:           Number(length),
        quantity:         qty,
        agentPrice:       unitAgent,
        sellingPrice,
        warehouseStockId: selectedWarehouseItem.id
      }]
    });

    btn.disabled = false;
    btn.textContent = 'Add Distribution';

    if (result.success) {
      closeModal();
      await loadPage();
    } else {
      showErr('Error saving: ' + result.error);
    }
  });

  // ‚îÄ‚îÄ Listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setupListeners() {
    document.getElementById('openModalBtn').addEventListener('click', openModal);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    document.getElementById('search').addEventListener('input', () => renderTable(distributions));
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await logout();
      window.location.href = 'index.html';
    });
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showErr(msg) {
    const el = document.getElementById('formError');
    el.textContent = msg; el.style.display = 'block';
  }
  function fmt(n) {
    return Number(n||0).toLocaleString('en-GH',{minimumFractionDigits:2,maximumFractionDigits:2});
  }
  function esc(str) {
    return String(str??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }
  function toDateStr(val) {
    if (!val) return '‚Äî';
    if (val.toDate)   return val.toDate().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    if (val.seconds)  return new Date(val.seconds*1000).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    return new Date(val).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
  }

  init();
</script>
</body>
</html>
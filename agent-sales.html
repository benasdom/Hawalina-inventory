<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Sales â€¢ Hawalina Ventures</title>
  <style>
    :root{
      --primary:#6f4cff;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;--info:#3b82f6;
      --line:#ece7ff;--muted:#6b6b7a;--text:#1f1f2a;
      --shadow:0 8px 24px rgba(25,10,70,.08);--r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:radial-gradient(1100px 500px at 60% 0%,rgba(111,76,255,.12),transparent 55%),#f7f4ff;
    }
    a{text-decoration:none;color:inherit}

    .app{display:flex;min-height:100vh}

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar{width:250px;padding:20px 16px;background:linear-gradient(180deg,#1a0a3c,#120730);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;flex-shrink:0}
    .brand{display:flex;gap:10px;align-items:center;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:12px}
    .brandIcon{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px;flex-shrink:0}
    .brand h2{font-size:15px;margin:0;line-height:1.2}
    .brand p{margin:2px 0 0;color:rgba(255,255,255,.55);font-size:11px}
    .nav{display:flex;flex-direction:column;gap:3px;flex:1}
    .nav a{padding:9px 11px;border-radius:11px;color:rgba(255,255,255,.75);display:flex;gap:9px;align-items:center;font-size:13px;transition:background .15s}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .navIco{width:17px;height:17px;border-radius:5px;display:inline-grid;place-items:center;background:rgba(255,255,255,.1);font-size:10px;flex-shrink:0}
    .sideFooter{margin-top:auto;padding-top:14px;border-top:1px solid rgba(255,255,255,.1)}
    .agentMeta{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .agentAvatar{width:36px;height:36px;border-radius:11px;background:rgba(255,255,255,.14);display:grid;place-items:center;font-size:16px;flex-shrink:0}
    .agentName{font-weight:700;font-size:13px;margin:0;color:#fff}
    .agentId{color:rgba(255,255,255,.5);font-size:11px;margin:2px 0 0}
    .logoutBtn{width:100%;padding:9px 12px;border-radius:11px;border:1px solid rgba(255,255,255,.14);background:transparent;color:rgba(255,255,255,.65);cursor:pointer;font-size:12px;display:flex;gap:8px;align-items:center;justify-content:center}
    .logoutBtn:hover{background:rgba(220,50,50,.2);color:#fff}

    /* â”€â”€ Main â”€â”€ */
    .main{flex:1;padding:28px 28px 60px;min-width:0}
    @media(max-width:640px){.sidebar{display:none}.main{padding:16px 14px 40px}}

    .topBar{margin-bottom:22px}
    .topBar h1{margin:0 0 4px;font-size:26px}
    .topBar p{margin:0;color:var(--muted);font-size:14px}

    /* â”€â”€ KPI cards â”€â”€ */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(170px,1fr));gap:13px;margin-bottom:18px}
    @media(max-width:1100px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:580px){.kpis{grid-template-columns:1fr}}
    .kpiCard{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);padding:15px 15px 17px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:11px;align-items:flex-start}
    .kpiCard::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px}
    .kpiCard.c-primary::before{background:linear-gradient(180deg,#6f4cff,#a78bfa)}
    .kpiCard.c-success::before{background:linear-gradient(180deg,#34d399,#10b981)}
    .kpiCard.c-warn::before{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
    .kpiCard.c-info::before{background:linear-gradient(180deg,#60a5fa,#3b82f6)}
    .kpiIco{width:44px;height:44px;border-radius:13px;background:rgba(111,76,255,.09);border:1px solid rgba(111,76,255,.16);display:grid;place-items:center;font-size:20px;flex-shrink:0}
    .kpiLabel{font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;font-weight:800;margin:0 0 5px}
    .kpiVal{font-size:21px;font-weight:900;margin:0 0 3px;color:var(--text)}
    .kpiHint{font-size:12px;color:var(--muted);margin:0}

    /* â”€â”€ Panel â”€â”€ */
    .panel{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .panelHead{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .panelHead h3{margin:0;font-size:15px}
    .panelBody{padding:0}

    /* â”€â”€ Filters â”€â”€ */
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:14px 18px;border-bottom:1px solid var(--line);background:rgba(111,76,255,.02)}
    .searchWrap{position:relative;flex:1;min-width:180px}
    .searchWrap input{padding:9px 12px 9px 34px;border:2px solid #e5e7eb;border-radius:10px;font-size:13px;width:100%;outline:none}
    .searchWrap input:focus{border-color:var(--primary)}
    .searchIco{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 12px;border-radius:20px;border:1px solid var(--line);background:#fff;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap;color:var(--muted)}
    .chip:hover{border-color:var(--primary);color:var(--primary)}
    .chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .exportBtn{padding:8px 14px;border-radius:10px;border:none;background:rgba(111,76,255,.1);color:var(--primary);font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap}
    .exportBtn:hover{background:rgba(111,76,255,.18)}

    /* â”€â”€ Table â”€â”€ */
    .tableWrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead tr{background:rgba(111,76,255,.04)}
    th{padding:11px 14px;text-align:left;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;white-space:nowrap;border-bottom:1px solid var(--line)}
    td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover{background:rgba(111,76,255,.03)}
    .commVal{color:var(--success);font-weight:800}
    .badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700}
    .badge.sale{background:rgba(16,185,129,.1);color:var(--success)}

    /* â”€â”€ Empty / loading â”€â”€ */
    .empty{color:var(--muted);font-size:13px;text-align:center;padding:40px 0}
    .loading{color:var(--muted);font-size:13px;text-align:center;padding:40px 0}

    /* â”€â”€ Pagination â”€â”€ */
    .pagination{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-top:1px solid var(--line);font-size:13px;color:var(--muted)}
    .pageBtn{padding:6px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:12px;font-weight:700;color:var(--text)}
    .pageBtn:hover:not(:disabled){border-color:var(--primary);color:var(--primary)}
    .pageBtn:disabled{opacity:.4;cursor:not-allowed}
  </style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brandIcon">âœ¦</div>
      <div><h2>Hawalina Ventures</h2><p>Agent Portal</p></div>
    </div>
    <nav class="nav">
      <a href="agent-dashboard.html"><span class="navIco">ğŸ§©</span>Dashboard</a>
      <a href="agent-record-sale.html"><span class="navIco">ğŸ’°</span>Record Sale</a>
      <a class="active" href="agent-sales.html"><span class="navIco">ğŸ“‹</span>My Sales</a>
      <a href="agent-stock.html"><span class="navIco">ğŸ“¦</span>My Stock</a>
      <a href="agent-commission.html"><span class="navIco">ğŸ’µ</span>My Commission</a>
      <a href="agent-performance.html"><span class="navIco">ğŸ“ˆ</span>Performance</a>
    </nav>
    <div class="sideFooter">
      <div class="agentMeta">
        <div class="agentAvatar">ğŸ‘¤</div>
        <div>
          <p class="agentName" id="sidebarName">Loading...</p>
          <p class="agentId"   id="sidebarId">â€”</p>
        </div>
      </div>
      <button class="logoutBtn" id="logoutBtn">ğŸšª &nbsp;Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topBar">
      <h1>ğŸ“‹ My Sales History</h1>
      <p>All your recorded transactions â€” live from Firestore</p>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpiCard c-primary">
        <div class="kpiIco">ğŸ’°</div>
        <div>
          <p class="kpiLabel">Total Revenue</p>
          <p class="kpiVal" id="kpiRevenue">GHS â€”</p>
          <p class="kpiHint" id="kpiRevenueHint">All time</p>
        </div>
      </div>
      <div class="kpiCard c-success">
        <div class="kpiIco">ğŸ’µ</div>
        <div>
          <p class="kpiLabel">Total Commission</p>
          <p class="kpiVal" id="kpiCommission">GHS â€”</p>
          <p class="kpiHint" id="kpiCommHint">All time</p>
        </div>
      </div>
      <div class="kpiCard c-warn">
        <div class="kpiIco">ğŸ“Š</div>
        <div>
          <p class="kpiLabel">Avg Sale Value</p>
          <p class="kpiVal" id="kpiAvg">GHS â€”</p>
          <p class="kpiHint" id="kpiAvgHint">Per transaction</p>
        </div>
      </div>
      <div class="kpiCard c-info">
        <div class="kpiIco">ğŸ“¦</div>
        <div>
          <p class="kpiLabel">Units Sold</p>
          <p class="kpiVal" id="kpiUnits">â€”</p>
          <p class="kpiHint" id="kpiUnitsHint">All time</p>
        </div>
      </div>
    </div>

    <!-- Table panel -->
    <div class="panel">
      <div class="panelHead">
        <h3>Sales Records</h3>
        <button class="exportBtn" id="exportBtn">ğŸ“¥ Export CSV</button>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="searchWrap">
          <span class="searchIco">ğŸ”</span>
          <input type="text" id="searchInput" placeholder="Search customer, productâ€¦">
        </div>
        <div class="chips">
          <button class="chip active" data-period="all">All Time</button>
          <button class="chip" data-period="7">7 Days</button>
          <button class="chip" data-period="30">30 Days</button>
          <button class="chip" data-period="month">This Month</button>
        </div>
      </div>

      <!-- Table -->
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Customer</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Total</th>
              <th>Commission</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="7" class="loading">Loading your salesâ€¦</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <span id="pageInfo">â€” records</span>
        <div style="display:flex;gap:8px">
          <button class="pageBtn" id="prevBtn" disabled>â† Prev</button>
          <button class="pageBtn" id="nextBtn" disabled>Next â†’</button>
        </div>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { requireRole, logout, onAuthChange } from './auth.js';
  import { getAllAgents, getSales } from './firestore-db.js';

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let allSales     = [];
  let filtered     = [];
  let currentPage  = 1;
  const PAGE_SIZE  = 20;
  let activePeriod = 'all';
  let searchTerm   = '';

  // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const allowed = await requireRole('agent');
    if (!allowed) return;

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await logout();
        window.location.href = 'index.html';
      }
    });

    onAuthChange(async (user) => {
      if (!user) return;

      const allRes = await getAllAgents();
      if (!allRes.success) return;

      // Retry up to 3 times with backoff â€” Firestore can be slow on first load
      let allAgentsData = allRes.data;
      let match = allAgentsData.find(a => a.firebaseUid === user.uid);
      if (!match) {
        for (let attempt = 2; attempt <= 3; attempt++) {
          await new Promise(r => setTimeout(r, attempt * 800));
          const retryRes = await getAllAgents();
          if (retryRes.success && retryRes.data.length > 0) {
            match = retryRes.data.find(a => a.firebaseUid === user.uid);
            if (match) break;
          }
        }
      }
      if (!match) {
        document.getElementById('sidebarName').textContent = 'Profile error';
        document.getElementById('sidebarId').textContent   = 'Contact admin';
        console.warn('Agent profile not found for uid:', user.uid);
        return;
      }

      document.getElementById('sidebarName').textContent = match.fullName || match.name || 'Agent';
      document.getElementById('sidebarId').textContent   = match.nationalId || 'â€”';

      await loadSales(match.id);
    });
  }

  // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSales(agentId) {
    const res = await getSales(agentId);
    allSales  = res.success ? res.data : [];
    applyFilters();
  }

  // â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    const now      = new Date();
    const thisM    = now.getMonth();
    const thisY    = now.getFullYear();

    filtered = allSales.filter(s => {
      const d = toDate(s.saleDate);

      // Period filter
      if (activePeriod !== 'all' && d) {
        if (activePeriod === '7') {
          const cutoff = new Date(now); cutoff.setDate(now.getDate() - 7);
          if (d < cutoff) return false;
        } else if (activePeriod === '30') {
          const cutoff = new Date(now); cutoff.setDate(now.getDate() - 30);
          if (d < cutoff) return false;
        } else if (activePeriod === 'month') {
          if (d.getMonth() !== thisM || d.getFullYear() !== thisY) return false;
        }
      }

      // Search filter
      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        const cust    = (s.customerName || s.customer || '').toLowerCase();
        const brand   = (s.hairBrand || s.brand || '').toLowerCase();
        const color   = (s.color || '').toLowerCase();
        const length  = String(s.length || '').toLowerCase();
        if (!cust.includes(q) && !brand.includes(q) && !color.includes(q) && !length.includes(q)) return false;
      }

      return true;
    });

    currentPage = 1;
    renderKPIs();
    renderTable();
  }

  // â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderKPIs() {
    const revenue    = filtered.reduce((s, d) => s + (d.totalSellingPrice || 0), 0);
    const commission = filtered.reduce((s, d) => s + (d.agentCommission   || 0), 0);
    const units      = filtered.reduce((s, d) => s + (d.quantity          || 0), 0);
    const avg        = filtered.length > 0 ? revenue / filtered.length : 0;

    document.getElementById('kpiRevenue').textContent    = 'GHS ' + fmt(revenue);
    document.getElementById('kpiCommission').textContent = 'GHS ' + fmt(commission);
    document.getElementById('kpiAvg').textContent        = 'GHS ' + fmt(avg);
    document.getElementById('kpiUnits').textContent      = units.toLocaleString();

    const label = activePeriod === 'all'   ? 'All time' :
                  activePeriod === '7'     ? 'Last 7 days' :
                  activePeriod === '30'    ? 'Last 30 days' : 'This month';
    document.getElementById('kpiRevenueHint').textContent = label + ` Â· ${filtered.length} sale${filtered.length !== 1 ? 's' : ''}`;
    document.getElementById('kpiCommHint').textContent    = label;
    document.getElementById('kpiAvgHint').textContent     = `Per transaction`;
    document.getElementById('kpiUnitsHint').textContent   = label;
  }

  // â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const body  = document.getElementById('tableBody');
    const total = filtered.length;
    const start = (currentPage - 1) * PAGE_SIZE;
    const page  = filtered.slice(start, start + PAGE_SIZE);

    if (!total) {
      body.innerHTML = `<tr><td colspan="7" class="empty">No sales found for this period.</td></tr>`;
      document.getElementById('pageInfo').textContent = '0 records';
      document.getElementById('prevBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;
      return;
    }

    body.innerHTML = page.map(s => {
      const d       = toDate(s.saleDate);
      const dateStr = d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
      const product = [s.hairBrand || s.brand, s.color, s.length ? `${s.length}"` : ''].filter(Boolean).join(' ');
      const phone   = s.customerPhone ? `<br><small style="color:var(--muted)">${esc(s.customerPhone)}</small>` : '';

      return `<tr>
        <td style="white-space:nowrap;color:var(--muted)">${dateStr}</td>
        <td><strong>${esc(s.customerName || s.customer || 'â€”')}</strong>${phone}</td>
        <td>${esc(product || 'â€”')}</td>
        <td style="text-align:center">${s.quantity || 1}</td>
        <td>GHS ${fmt(s.sellingPrice)}</td>
        <td style="font-weight:700">GHS ${fmt(s.totalSellingPrice)}</td>
        <td><strong class="commVal">+GHS ${fmt(s.agentCommission)}</strong></td>
      </tr>`;
    }).join('');

    const end = Math.min(start + PAGE_SIZE, total);
    document.getElementById('pageInfo').textContent = `${start + 1}â€“${end} of ${total} record${total !== 1 ? 's' : ''}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= total;
  }

  // â”€â”€ Wire controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.chip[data-period]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.chip[data-period]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activePeriod = btn.dataset.period;
      applyFilters();
    });
  });

  document.getElementById('searchInput').addEventListener('input', function() {
    searchTerm = this.value.trim();
    applyFilters();
  });

  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentPage > 1) { currentPage--; renderTable(); }
  });
  document.getElementById('nextBtn').addEventListener('click', () => {
    const maxPage = Math.ceil(filtered.length / PAGE_SIZE);
    if (currentPage < maxPage) { currentPage++; renderTable(); }
  });

  // â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('exportBtn').addEventListener('click', () => {
    if (!filtered.length) return;
    const rows = [
      ['Date','Customer','Phone','Product','Qty','Unit Price','Total','Commission'],
      ...filtered.map(s => {
        const d       = toDate(s.saleDate);
        const dateStr = d ? d.toLocaleDateString('en-GB') : '';
        const product = [s.hairBrand || s.brand, s.color, s.length ? `${s.length}"` : ''].filter(Boolean).join(' ');
        return [
          dateStr,
          s.customerName || s.customer || '',
          s.customerPhone || '',
          product,
          s.quantity || 1,
          s.sellingPrice || 0,
          s.totalSellingPrice || 0,
          s.agentCommission || 0
        ];
      })
    ];
    const csv  = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `my-sales-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toDate(val) {
    if (!val) return null;
    if (val.toDate)  return val.toDate();
    if (val.seconds) return new Date(val.seconds * 1000);
    return new Date(val);
  }
  function fmt(n) {
    return Number(n || 0).toLocaleString('en-GH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function esc(str) {
    return String(str ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  init();
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Catalog â€¢ Hawalina Ventures</title>
  <style>
    :root{
      --bg:#f7f4ff;--text:#1f1f2a;--muted:#6b6b7a;--primary:#6f4cff;
      --line:#ece7ff;--shadow:0 10px 25px rgba(25,10,70,.08);--r:18px;
      --danger:#ef4444;--success:#10b981;--warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 70% 0%,rgba(111,76,255,.22),transparent 55%),
        radial-gradient(900px 500px at 0% 30%,rgba(139,107,255,.14),transparent 60%),
        var(--bg);
    }
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh}

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar{width:260px;padding:22px 18px;background:linear-gradient(180deg,#24134f,#1a1036);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;}
    .brand{display:flex;gap:12px;align-items:center;padding:10px 10px 18px}
    .logo{width:46px;height:46px;border-radius:16px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px}
    .brand h1{font-size:18px;margin:0;line-height:1.1}
    .brand p{margin:4px 0 0;color:rgba(255,255,255,.7);font-size:12px}
    .nav{margin-top:10px;display:flex;flex-direction:column;gap:6px;flex:1}
    .nav a{padding:10px 12px;border-radius:12px;color:rgba(255,255,255,.86);display:flex;gap:10px;align-items:center}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .ico{width:18px;height:18px;border-radius:6px;display:inline-grid;place-items:center;background:rgba(255,255,255,.10);font-size:12px}
    .logout-btn{margin-top:auto;padding:10px 12px;border-radius:12px;color:rgba(255,255,255,.7);display:flex;gap:10px;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,.15);background:transparent;width:100%;font-size:14px;}
    .logout-btn:hover{background:rgba(255,0,0,.2);color:#fff}

    /* â”€â”€ Main â”€â”€ */
    .main{flex:1;padding:26px 26px 40px}
    @media(max-width:620px){.sidebar{display:none}}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
    .titleWrap{display:flex;gap:10px;align-items:flex-start}
    .pageIcon{width:42px;height:42px;border-radius:14px;background:rgba(111,76,255,.12);border:1px solid rgba(111,76,255,.18);display:grid;place-items:center;font-size:18px;margin-top:2px}
    .title h2{margin:0;font-size:30px}
    .title small{color:var(--muted);display:block;margin-top:4px}

    /* â”€â”€ KPIs â”€â”€ */
    .kpis{margin-top:16px;display:grid;grid-template-columns:repeat(4,minmax(200px,1fr));gap:14px}
    @media(max-width:1150px){.kpis{grid-template-columns:repeat(2,minmax(200px,1fr))}}
    @media(max-width:620px){.kpis{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.86);border:1px solid var(--line);border-radius:var(--r);padding:14px 14px 16px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:12px;align-items:flex-start;}
    .stripe{position:absolute;left:0;top:0;bottom:0;width:5px}
    .cardIcon{width:46px;height:46px;border-radius:14px;background:rgba(111,76,255,.10);border:1px solid rgba(111,76,255,.18);display:grid;place-items:center;font-size:22px;flex:0 0 auto}
    .cardText{flex:1}
    .cardTitle{font-size:12px;letter-spacing:.02em;color:#3c3c52;text-transform:uppercase;margin:2px 0 6px;font-weight:800}
    .cardValue{font-size:26px;font-weight:900;margin:0}
    .cardHint{margin:4px 0 0;color:var(--muted);font-size:12px}

    /* â”€â”€ Filters â”€â”€ */
    .filtersPanel{margin-top:14px;background:rgba(255,255,255,.70);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .filtersRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{border:1px solid var(--line);background:rgba(255,255,255,.85);padding:9px 12px;border-radius:999px;font-size:13px;cursor:pointer;color:#2b2b3c;font-weight:600}
    .chip:hover{border-color:rgba(111,76,255,.4)}
    .chip.active{background:rgba(111,76,255,.16);border-color:rgba(111,76,255,.35);color:var(--primary)}
    .filtersRow2{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .agentSelect{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:13px;font-weight:600;outline:none;cursor:pointer;min-width:200px}
    .search{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;min-width:260px;outline:none}

    /* â”€â”€ Panel â”€â”€ */
    .panel{margin-top:14px;background:rgba(255,255,255,.80);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .panelHeader{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);gap:10px;flex-wrap:wrap}
    .panelHeader h3{margin:0;font-size:18px}
    .newBtn{padding:10px 14px;border-radius:12px;border:1px solid rgba(111,76,255,.35);background:rgba(111,76,255,.10);cursor:pointer;display:inline-flex;gap:8px;align-items:center;font-weight:800;color:var(--primary)}
    .newBtn:hover{background:rgba(111,76,255,.18)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);font-size:13px;text-align:left;vertical-align:middle;white-space:nowrap}
    th{background:rgba(111,76,255,.06);color:#4b4b63;font-weight:900}
    tbody tr:hover td{background:rgba(111,76,255,.035)}
    .badge-paid{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:800;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.25);color:#065f46}
    .badge-partial{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:800;background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.3);color:#7c5200}
    .tfoot{padding:10px 14px;color:var(--muted);font-size:12px;background:rgba(255,255,255,.55)}
    .empty{text-align:center;color:var(--muted);padding:20px 10px}

    /* â”€â”€ Modal â”€â”€ */
    .modal{position:fixed;inset:0;background:rgba(15,10,40,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .modal.open{display:flex}
    .box{width:min(860px,96vw);background:#fff;border-radius:18px;box-shadow:var(--shadow);border:1px solid var(--line);overflow:hidden;max-height:92vh;overflow-y:auto}
    .boxHead{padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);position:sticky;top:0;background:#fff;z-index:2}
    .boxHead h4{margin:0;font-size:22px}
    .closeX{width:40px;height:36px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:18px}
    .boxBody{padding:18px 18px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:820px){.grid2{grid-template-columns:1fr}}
    .field label{display:block;font-size:12px;color:#3c3c52;margin:0 0 6px;font-weight:900}
    .req{color:var(--danger);margin-left:3px}
    .field input,.field select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none;font-size:14px;background:#fff}
    .field input:focus,.field select:focus{border-color:var(--primary)}
    .miniNote{margin:6px 0 0;color:var(--muted);font-size:12px}
    .agentInfo{margin-top:14px;padding:14px;border-radius:14px;background:rgba(111,76,255,.06);border:1px solid var(--line);display:none}
    .agentInfo.show{display:block}
    .agentInfoRow{display:flex;gap:10px;flex-wrap:wrap}
    .agentInfoItem{flex:1;min-width:140px}
    .agentInfoItem .label{font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:4px}
    .agentInfoItem .val{font-size:18px;font-weight:900}
    .form-error{display:none;margin:8px 18px 0;padding:10px 12px;border-radius:12px;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.25);color:#b91c1c;font-size:13px}
    .actions{display:flex;justify-content:flex-end;gap:10px;padding:14px 18px 18px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid transparent;background:var(--primary);color:#fff;cursor:pointer;box-shadow:var(--shadow);display:inline-flex;gap:8px;align-items:center;font-weight:800;}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--line);box-shadow:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">âœ¦</div>
      <div><h1>Hawalina Ventures</h1><p>CEO Portal</p></div>
    </div>
    <nav class="nav">
      <a href="dashboard.html"><span class="ico">ğŸ§©</span>Dashboard</a>
      <a href="warehouse.html"><span class="ico">ğŸ“¦</span>Warehouse</a>
      <a href="products.html"><span class="ico">ğŸ§´</span>Products</a>
      <a href="agents.html"><span class="ico">ğŸ§‘ğŸ¾â€ğŸ’¼</span>Agents</a>
      <a href="distribute.html"><span class="ico">ğŸšš</span>Distribute Stock</a>
      <a href="sales.html"><span class="ico">ğŸ§¾</span>All Sales</a>
      <a class="active" href="payments.html"><span class="ico">ğŸ’³</span>Payments</a>
      <a href="stockbalance.html"><span class="ico">ğŸ“Š</span>Stock Balance</a>
      <a href="analytics.html"><span class="ico">ğŸ“ˆ</span>Analytics</a>
      <a href="settings.html"><span class="ico">âš™ï¸</span>Settings</a>
    </nav>
    <button class="logout-btn" id="logoutBtn">â‹ &nbsp;Logout</button>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="titleWrap">
        <div class="pageIcon">ğŸ’³</div>
        <div class="title">
          <h2>Payment Catalog</h2>
          <small>Record and view payments made to agents</small>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <section class="kpis">
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#34d399,#10b981)"></span>
        <div class="cardIcon">ğŸ’µ</div>
        <div class="cardText">
          <div class="cardTitle">TOTAL PAID OUT</div>
          <p class="cardValue">GHS <span id="kpiTotal">0.00</span></p>
          <p class="cardHint">Total payments recorded</p>
        </div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#fbbf24,#f59e0b)"></span>
        <div class="cardIcon">ğŸ“‹</div>
        <div class="cardText">
          <div class="cardTitle">TOTAL PAYMENTS</div>
          <p class="cardValue"><span id="kpiCount">0</span></p>
          <p class="cardHint">Payment transactions</p>
        </div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#60a5fa,#3b82f6)"></span>
        <div class="cardIcon">ğŸ‘¥</div>
        <div class="cardText">
          <div class="cardTitle">AGENTS PAID</div>
          <p class="cardValue"><span id="kpiAgents">0</span></p>
          <p class="cardHint">Unique agents with payments</p>
        </div>
      </div>
      <div class="card">
        <span class="stripe" style="background:linear-gradient(180deg,#ffb86b,#6f4cff)"></span>
        <div class="cardIcon">ğŸ’°</div>
        <div class="cardText">
          <div class="cardTitle">LARGEST PAYMENT</div>
          <p class="cardValue">GHS <span id="kpiMax">0.00</span></p>
          <p class="cardHint">Single highest payment</p>
        </div>
      </div>
    </section>

    <!-- Filters -->
    <section class="filtersPanel">
      <div class="filtersRow">
        <div class="chipbar">
          <button class="chip active" data-period="all">All Time</button>
          <button class="chip" data-period="7days">7 Days</button>
          <button class="chip" data-period="30days">30 Days</button>
          <button class="chip" data-period="thismonth">This Month</button>
          <button class="chip" data-period="thisquarter">This Quarter</button>
          <button class="chip" data-period="thisyear">This Year</button>
        </div>
      </div>
      <div class="filtersRow2">
        <select class="agentSelect" id="agentFilter">
          <option value="">All Agents</option>
        </select>
        <input class="search" id="search" placeholder="Search payments..." />
      </div>
    </section>

    <!-- Table -->
    <section class="panel">
      <div class="panelHeader">
        <h3>ğŸ’³ Payment Records</h3>
        <button class="newBtn" id="openModalBtn">ï¼‹ New Payment</button>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>DATE</th>
              <th>AGENT</th>
              <th>AMOUNT PAID</th>
              <th>PAYMENT METHOD</th>
              <th>NOTES</th>
              <th>RECORDED BY</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="empty">Loading payments...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tfoot"><span id="countLabel">0 records</span></div>
    </section>
  </main>
</div>

<!-- New Payment Modal -->
<div class="modal" id="modal">
  <div class="box" role="dialog" aria-modal="true">
    <div class="boxHead">
      <h4>ğŸ’³ Record New Payment</h4>
      <button class="closeX" id="closeModalBtn">Ã—</button>
    </div>
    <div class="form-error" id="formError"></div>
    <div class="boxBody">
      <div class="grid2">

        <div class="field" style="grid-column:1/-1">
          <label>Agent <span class="req">*</span></label>
          <select id="f_agent">
            <option value="">Select Agent</option>
          </select>
        </div>

        <!-- Agent balance info (shown after selecting agent) -->
        <div class="agentInfo" id="agentInfo" style="grid-column:1/-1">
          <div class="agentInfoRow">
            <div class="agentInfoItem">
              <div class="label">Total Owed</div>
              <div class="val" id="info_owed">GHS 0.00</div>
            </div>
            <div class="agentInfoItem">
              <div class="label">Total Paid</div>
              <div class="val" id="info_paid">GHS 0.00</div>
            </div>
            <div class="agentInfoItem">
              <div class="label">Commission Earned</div>
              <div class="val" id="info_commission">GHS 0.00</div>
            </div>
          </div>
        </div>

        <div class="field">
          <label>Amount (GHS) <span class="req">*</span></label>
          <input type="number" id="f_amount" min="0" step="0.01" placeholder="e.g., 500.00" />
        </div>

        <div class="field">
          <label>Payment Method <span class="req">*</span></label>
          <select id="f_method">
            <option value="">Select Method</option>
            <option>Mobile Money (MoMo)</option>
            <option>Bank Transfer</option>
            <option>Cash</option>
            <option>Cheque</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>Notes</label>
          <input type="text" id="f_notes" placeholder="Optional notes about this payment..." />
        </div>

      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="cancelBtn">Cancel</button>
      <button class="btn" id="addBtn">Record Payment</button>
    </div>
  </div>
</div>

<script type="module">
  import { requireRole, logout } from './auth.js';
  import { getAllAgents, addPayment, getPayments } from './firestore-db.js';

  let allPayments = [];
  let agents      = [];
  let activePeriod = 'all';
  let activeAgent  = '';

  // â”€â”€ Auth guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const allowed = await requireRole('ceo');
    if (!allowed) return;
    setupListeners();
    await loadData();
  }

  // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadData() {
    document.getElementById('tbody').innerHTML =
      '<tr><td colspan="7" class="empty">Loading payments...</td></tr>';

    const [payRes, agentRes] = await Promise.all([
      getPayments(),     // all payments, no filter
      getAllAgents()
    ]);

    allPayments = payRes.success   ? payRes.data   : [];
    agents      = agentRes.success ? agentRes.data : [];

    // Populate agent filter dropdown
    const agentFilterSel = document.getElementById('agentFilter');
    agentFilterSel.innerHTML = '<option value="">All Agents</option>';
    agents.forEach(a => {
      const name = a.fullName || a.name || 'Unknown';
      agentFilterSel.innerHTML += `<option value="${a.id}">${esc(name)}</option>`;
    });

    // Populate modal agent dropdown
    const modalAgentSel = document.getElementById('f_agent');
    modalAgentSel.innerHTML = '<option value="">Select Agent</option>';
    agents.forEach(a => {
      const name = a.fullName || a.name || 'Unknown';
      modalAgentSel.innerHTML +=
        `<option value="${a.id}"
          data-owed="${a.totalOwed||0}"
          data-paid="${a.totalPaid||0}"
          data-commission="${a.totalCommission||0}">
          ${esc(name)}
        </option>`;
    });

    applyFilters();
  }

  // â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    const search = document.getElementById('search').value.trim().toLowerCase();
    const now    = new Date();

    const filtered = allPayments.filter(p => {
      const pDate = toDate(p.paymentDate);

      // Period
      if (activePeriod !== 'all' && pDate) {
        if (activePeriod === '7days') {
          const cut = new Date(now); cut.setDate(now.getDate() - 7);
          if (pDate < cut) return false;
        } else if (activePeriod === '30days') {
          const cut = new Date(now); cut.setDate(now.getDate() - 30);
          if (pDate < cut) return false;
        } else if (activePeriod === 'thismonth') {
          if (pDate.getMonth() !== now.getMonth() || pDate.getFullYear() !== now.getFullYear()) return false;
        } else if (activePeriod === 'thisquarter') {
          const q = Math.floor(now.getMonth() / 3);
          if (Math.floor(pDate.getMonth() / 3) !== q || pDate.getFullYear() !== now.getFullYear()) return false;
        } else if (activePeriod === 'thisyear') {
          if (pDate.getFullYear() !== now.getFullYear()) return false;
        }
      }

      // Agent
      if (activeAgent && p.agentId !== activeAgent) return false;

      // Search
      if (search) {
        const blob = `${p.agentName||''} ${p.paymentMethod||''} ${p.notes||''}`.toLowerCase();
        if (!blob.includes(search)) return false;
      }

      return true;
    });

    updateKPIs(filtered);
    renderTable(filtered);
  }

  // â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateKPIs(payments) {
    const total   = payments.reduce((s, p) => s + (p.amount || 0), 0);
    const agentIds = new Set(payments.map(p => p.agentId).filter(Boolean));
    const max     = payments.reduce((s, p) => Math.max(s, p.amount || 0), 0);
    document.getElementById('kpiTotal').textContent  = fmt(total);
    document.getElementById('kpiCount').textContent  = payments.length;
    document.getElementById('kpiAgents').textContent = agentIds.size;
    document.getElementById('kpiMax').textContent    = fmt(max);
  }

  // â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable(payments) {
    const tbody = document.getElementById('tbody');
    if (!payments.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty">No payment records found.</td></tr>';
      document.getElementById('countLabel').textContent = '0 records';
      return;
    }

    tbody.innerHTML = payments.map(p => {
      const agentName = p.agentName   || 'â€”';
      const method    = p.paymentMethod || 'â€”';
      const notes     = p.notes       || 'â€”';
      const recordedBy = p.recordedBy || 'Admin';
      const statusHtml = `<span class="badge-paid">âœ“ Paid</span>`;

      return `<tr>
        <td>${esc(toDateStr(p.paymentDate))}</td>
        <td><strong>${esc(agentName)}</strong></td>
        <td><strong>GHS ${fmt(p.amount)}</strong></td>
        <td>${esc(method)}</td>
        <td>${esc(notes)}</td>
        <td>${esc(recordedBy)}</td>
        <td>${statusHtml}</td>
      </tr>`;
    }).join('');

    document.getElementById('countLabel').textContent =
      `${payments.length} record${payments.length !== 1 ? 's' : ''}`;
  }

  // â”€â”€ Modal agent selection â†’ show balance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('f_agent').addEventListener('change', function() {
    const opt  = this.options[this.selectedIndex];
    const info = document.getElementById('agentInfo');
    if (!this.value) { info.classList.remove('show'); return; }
    document.getElementById('info_owed').textContent       = 'GHS ' + fmt(opt.dataset.owed);
    document.getElementById('info_paid').textContent       = 'GHS ' + fmt(opt.dataset.paid);
    document.getElementById('info_commission').textContent = 'GHS ' + fmt(opt.dataset.commission);
    info.classList.add('show');
  });

  // â”€â”€ Submit payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('addBtn').addEventListener('click', async () => {
    document.getElementById('formError').style.display = 'none';

    const agentSel  = document.getElementById('f_agent');
    const agentId   = agentSel.value;
    const agentOpt  = agentSel.options[agentSel.selectedIndex];
    const agentName = agentOpt ? agentOpt.text : '';
    const amount    = parseFloat(document.getElementById('f_amount').value);
    const method    = document.getElementById('f_method').value;
    const notes     = document.getElementById('f_notes').value.trim();

    if (!agentId)              return showErr('Please select an agent.');
    if (!amount || amount <= 0) return showErr('Please enter a valid payment amount.');
    if (!method)               return showErr('Please select a payment method.');

    const btn = document.getElementById('addBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';

    const result = await addPayment({
      agentId,
      agentName,
      amount,
      paymentMethod: method,
      notes,
      recordedBy: 'CEO Admin',
      paymentDate: new Date().toISOString()
    });

    btn.disabled = false;
    btn.textContent = 'Record Payment';

    if (result.success) {
      closeModal();
      await loadData();
    } else {
      showErr('Error recording payment: ' + result.error);
    }
  });

  // â”€â”€ Modal open/close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const modal = document.getElementById('modal');
  const closeModal = () => {
    modal.classList.remove('open');
    document.getElementById('agentInfo').classList.remove('show');
    document.getElementById('formError').style.display = 'none';
  };

  // â”€â”€ Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupListeners() {
    document.getElementById('openModalBtn').addEventListener('click', () => {
      document.getElementById('f_agent').value  = '';
      document.getElementById('f_amount').value = '';
      document.getElementById('f_method').value = '';
      document.getElementById('f_notes').value  = '';
      document.getElementById('agentInfo').classList.remove('show');
      document.getElementById('formError').style.display = 'none';
      modal.classList.add('open');
    });

    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', function() {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        activePeriod = this.dataset.period;
        applyFilters();
      });
    });

    document.getElementById('agentFilter').addEventListener('change', function() {
      activeAgent = this.value;
      applyFilters();
    });

    document.getElementById('search').addEventListener('input', applyFilters);

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await logout();
      window.location.href = 'index.html';
    });
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toDate(val) {
    if (!val) return null;
    if (val.toDate)  return val.toDate();
    if (val.seconds) return new Date(val.seconds * 1000);
    return new Date(val);
  }
  function toDateStr(val) {
    const d = toDate(val);
    return d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
  }
  function fmt(n) {
    return Number(n || 0).toLocaleString('en-GH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function esc(str) {
    return String(str ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }
  function showErr(msg) {
    const el = document.getElementById('formError');
    el.textContent = msg; el.style.display = 'block';
  }

  init();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Network â€¢ Hawalina Ventures</title>
  <style>
    :root{
      --primary:#6f4cff;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;--info:#3b82f6;
      --line:#ece7ff;--muted:#6b6b7a;--text:#1f1f2a;
      --shadow:0 8px 24px rgba(25,10,70,.08);--r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:radial-gradient(1100px 500px at 60% 0%,rgba(111,76,255,.12),transparent 55%),#f7f4ff;
    }
    a{text-decoration:none;color:inherit}
    .app{display:flex;min-height:100vh}

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar{width:250px;padding:20px 16px;background:linear-gradient(180deg,#1a0a3c,#120730);color:#fff;position:sticky;top:0;height:100vh;display:flex;flex-direction:column;flex-shrink:0}
    .brand{display:flex;gap:10px;align-items:center;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:12px}
    .brandIcon{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.12);display:grid;place-items:center;font-size:18px;flex-shrink:0}
    .brand h2{font-size:15px;margin:0;line-height:1.2}
    .brand p{margin:2px 0 0;color:rgba(255,255,255,.55);font-size:11px}
    .nav{display:flex;flex-direction:column;gap:3px;flex:1}
    .nav a{padding:9px 11px;border-radius:11px;color:rgba(255,255,255,.75);display:flex;gap:9px;align-items:center;font-size:13px;transition:background .15s}
    .nav a:hover,.nav a.active{background:rgba(255,255,255,.12);color:#fff}
    .navIco{width:17px;height:17px;border-radius:5px;display:inline-grid;place-items:center;background:rgba(255,255,255,.1);font-size:10px;flex-shrink:0}
    .sideFooter{margin-top:auto;padding-top:14px;border-top:1px solid rgba(255,255,255,.1)}
    .agentMeta{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .agentAvatar{width:36px;height:36px;border-radius:11px;background:rgba(255,255,255,.14);display:grid;place-items:center;font-size:16px;flex-shrink:0}
    .agentName{font-weight:700;font-size:13px;margin:0;color:#fff}
    .agentId{color:rgba(255,255,255,.5);font-size:11px;margin:2px 0 0}
    .logoutBtn{width:100%;padding:9px 12px;border-radius:11px;border:1px solid rgba(255,255,255,.14);background:transparent;color:rgba(255,255,255,.65);cursor:pointer;font-size:12px;display:flex;gap:8px;align-items:center;justify-content:center}
    .logoutBtn:hover{background:rgba(220,50,50,.2);color:#fff}

    /* â”€â”€ Main â”€â”€ */
    .main{flex:1;padding:28px 28px 60px;min-width:0}
    @media(max-width:640px){.sidebar{display:none}.main{padding:16px 14px 40px}}

    .topBar{margin-bottom:22px}
    .topBar h1{margin:0 0 4px;font-size:26px}
    .topBar p{margin:0;color:var(--muted);font-size:14px}

    /* â”€â”€ KPIs â”€â”€ */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(155px,1fr));gap:13px;margin-bottom:20px}
    @media(max-width:1050px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.kpis{grid-template-columns:1fr}}
    .kpiCard{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);padding:15px 15px 17px;box-shadow:var(--shadow);position:relative;overflow:hidden;display:flex;gap:11px;align-items:flex-start}
    .kpiCard::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px}
    .kpiCard.c-primary::before{background:linear-gradient(180deg,#6f4cff,#a78bfa)}
    .kpiCard.c-success::before{background:linear-gradient(180deg,#34d399,#10b981)}
    .kpiCard.c-warn::before{background:linear-gradient(180deg,#fbbf24,#f59e0b)}
    .kpiCard.c-info::before{background:linear-gradient(180deg,#60a5fa,#3b82f6)}
    .kpiIco{width:44px;height:44px;border-radius:13px;background:rgba(111,76,255,.09);border:1px solid rgba(111,76,255,.16);display:grid;place-items:center;font-size:20px;flex-shrink:0}
    .kpiLabel{font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;font-weight:800;margin:0 0 5px}
    .kpiVal{font-size:21px;font-weight:900;margin:0 0 3px;color:var(--text)}
    .kpiHint{font-size:12px;color:var(--muted);margin:0}

    /* â”€â”€ Tabs â”€â”€ */
    .tabs{display:flex;gap:4px;background:rgba(255,255,255,.7);border:1px solid var(--line);border-radius:14px;padding:5px;width:fit-content;margin-bottom:18px;flex-wrap:wrap}
    .tab{padding:8px 15px;border-radius:10px;border:none;background:transparent;font-size:13px;font-weight:700;cursor:pointer;color:var(--muted);transition:all .15s}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(111,76,255,.3)}

    /* â”€â”€ Panel â”€â”€ */
    .panel{background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px}
    .panelHead{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .panelHead h3{margin:0;font-size:15px}
    .panelHead .sub{font-size:12px;color:var(--muted)}
    .panelBody{padding:18px}

    /* â”€â”€ Table â”€â”€ */
    .tableWrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead tr{background:rgba(111,76,255,.04)}
    th{padding:11px 14px;text-align:left;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:#3c3c52;border-bottom:1px solid var(--line);white-space:nowrap}
    td{padding:11px 14px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover{background:rgba(111,76,255,.02)}
    .badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700}
    .badge.l1{background:rgba(16,185,129,.1);color:var(--success)}
    .badge.l2{background:rgba(59,130,246,.1);color:var(--info)}
    .commVal{color:var(--success);font-weight:800}

    /* â”€â”€ Dashboard grid â”€â”€ */
    .dashGrid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
    @media(max-width:900px){.dashGrid{grid-template-columns:1fr}}

    /* â”€â”€ Activity feed â”€â”€ */
    .activityItem{display:flex;gap:12px;align-items:flex-start;padding:12px 0;border-bottom:1px solid var(--line)}
    .activityItem:last-child{border-bottom:none}
    .activityIco{width:36px;height:36px;border-radius:11px;display:grid;place-items:center;font-size:15px;flex-shrink:0}
    .activityIco.l1{background:rgba(16,185,129,.1);color:var(--success)}
    .activityIco.l2{background:rgba(59,130,246,.1);color:var(--info)}
    .activityInfo{flex:1}
    .activityInfo strong{font-size:13px;display:block;margin:0 0 2px}
    .activityInfo small{font-size:12px;color:var(--muted)}
    .activityVal{font-size:13px;font-weight:800;color:var(--success);white-space:nowrap}

    /* â”€â”€ Commission breakdown â”€â”€ */
    .breakdownRow{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid var(--line)}
    .breakdownRow:last-child{border-bottom:none}
    .breakdownLabel{font-size:13px;color:var(--muted);font-weight:600}
    .breakdownVal{font-size:15px;font-weight:900}

    /* â”€â”€ Earnings summary bar â”€â”€ */
    .earningsSummary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px}
    @media(max-width:600px){.earningsSummary{grid-template-columns:1fr}}
    .earningBox{text-align:center;background:rgba(111,76,255,.05);border:1px solid var(--line);border-radius:14px;padding:14px 10px}
    .earningLabel{font-size:11px;text-transform:uppercase;letter-spacing:.05em;font-weight:800;color:var(--muted);margin:0 0 6px}
    .earningVal{font-size:20px;font-weight:900;margin:0;color:var(--text)}

    /* â”€â”€ Tree â”€â”€ */
    .treeRoot{display:flex;gap:12px;align-items:flex-start;padding:14px;background:rgba(111,76,255,.05);border:1px solid rgba(111,76,255,.15);border-radius:14px;margin-bottom:14px}
    .treeNodeIco{width:44px;height:44px;border-radius:13px;background:linear-gradient(135deg,#6f4cff,#a78bfa);display:grid;place-items:center;font-size:18px;flex-shrink:0;color:#fff}
    .treeNodeInfo strong{font-size:14px;display:block;margin:0 0 2px}
    .treeNodeInfo small{font-size:12px;color:var(--muted)}
    .treeStat{font-size:12px;color:var(--success);font-weight:700;margin-top:4px}
    .treeLevel{padding-left:26px;border-left:2px solid var(--line);margin-left:22px}
    .treeItem{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;margin-bottom:8px;position:relative}
    .treeItem::before{content:"";position:absolute;left:-28px;top:20px;width:28px;height:2px;background:var(--line)}
    .treeIco{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-size:14px;flex-shrink:0}
    .treeIco.l1{background:rgba(16,185,129,.1);color:var(--success)}
    .treeIco.l2{background:rgba(59,130,246,.1);color:var(--info)}
    .treeInfo{flex:1}
    .treeInfo strong{font-size:13px;display:block;margin:0 0 2px}
    .treeInfo small{font-size:11px;color:var(--muted)}
    .treeSide{text-align:right;flex-shrink:0}
    .treeSide .val{font-size:13px;font-weight:800;color:var(--success)}
    .treeSide .lbl{font-size:10px;color:var(--muted)}
    .l2Container{padding-left:24px;border-left:2px solid rgba(59,130,246,.2);margin-left:17px;margin-top:4px;margin-bottom:4px}
    .l2Container .treeItem{border-color:rgba(59,130,246,.15);background:rgba(59,130,246,.02)}
    .l2Container .treeItem::before{background:rgba(59,130,246,.2)}

    /* â”€â”€ Recruiter chip â”€â”€ */
    .recruiterChip{display:inline-flex;gap:8px;align-items:center;background:rgba(111,76,255,.07);border:1px solid rgba(111,76,255,.18);border-radius:12px;padding:8px 14px;font-size:13px;font-weight:700;color:var(--primary);margin-bottom:14px}
    .recruiterChip small{font-weight:500;color:var(--muted)}

    .empty{color:var(--muted);font-size:13px;text-align:center;padding:30px 0}
    .spinner{color:var(--muted);font-size:13px;text-align:center;padding:30px 0}
  </style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brandIcon">âœ¦</div>
      <div><h2>Hawalina Ventures</h2><p>Agent Portal</p></div>
    </div>
    <nav class="nav">
      <a href="agent-dashboard.html"><span class="navIco">ğŸ§©</span>Dashboard</a>
      <a href="agent-record-sale.html"><span class="navIco">ğŸ’°</span>Record Sale</a>
      <a href="agent-sales.html"><span class="navIco">ğŸ“‹</span>My Sales</a>
      <a href="agent-stock.html"><span class="navIco">ğŸ“¦</span>My Stock</a>
      <a href="agent-commission.html"><span class="navIco">ğŸ’µ</span>My Commission</a>
      <a href="agent-performance.html"><span class="navIco">ğŸ“ˆ</span>Performance</a>
      <a class="active" href="agent-referrals.html"><span class="navIco">ğŸ”—</span>My Network</a>
    </nav>
    <div class="sideFooter">
      <div class="agentMeta">
        <div class="agentAvatar">ğŸ‘¤</div>
        <div>
          <p class="agentName" id="sidebarName">Loading...</p>
          <p class="agentId"   id="sidebarId">â€”</p>
        </div>
      </div>
      <button class="logoutBtn" id="logoutBtn">ğŸšª &nbsp;Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topBar">
      <h1>ğŸ”— My Referral Network</h1>
      <p>Track your recruits and the commissions they generate for you</p>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpiCard c-primary">
        <div class="kpiIco">ğŸ‘¥</div>
        <div>
          <p class="kpiLabel">Level 1 Recruits</p>
          <p class="kpiVal" id="kpiL1">â€”</p>
          <p class="kpiHint">Direct referrals</p>
        </div>
      </div>
      <div class="kpiCard c-info">
        <div class="kpiIco">ğŸ”—</div>
        <div>
          <p class="kpiLabel">Level 2 Recruits</p>
          <p class="kpiVal" id="kpiL2">â€”</p>
          <p class="kpiHint">Your recruits' recruits</p>
        </div>
      </div>
      <div class="kpiCard c-success">
        <div class="kpiIco">ğŸ’°</div>
        <div>
          <p class="kpiLabel">Total Earned</p>
          <p class="kpiVal" id="kpiTotal">GHS â€”</p>
          <p class="kpiHint" id="kpiTotalHint">All referral commissions</p>
        </div>
      </div>
      <div class="kpiCard c-warn">
        <div class="kpiIco">ğŸ“…</div>
        <div>
          <p class="kpiLabel">This Month</p>
          <p class="kpiVal" id="kpiMonth">GHS â€”</p>
          <p class="kpiHint" id="kpiMonthHint">Referral earnings</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="dashboard">ğŸ“Š Dashboard</button>
      <button class="tab" data-tab="level1">ğŸ‘¥ Level 1</button>
      <button class="tab" data-tab="level2">ğŸ”— Level 2</button>
      <button class="tab" data-tab="earnings">ğŸ’° Earnings</button>
      <button class="tab" data-tab="tree">ğŸŒ³ Network Tree</button>
    </div>

    <!-- â”€â”€ TAB: Dashboard â”€â”€ -->
    <div id="tab-dashboard" class="tabPane">
      <div class="dashGrid">

        <!-- Recent activity -->
        <div class="panel">
          <div class="panelHead"><h3>ğŸ• Recent Activity</h3><span class="sub">Latest referral commissions</span></div>
          <div class="panelBody"><div id="recentActivity"><p class="spinner">Loadingâ€¦</p></div></div>
        </div>

        <!-- Commission breakdown -->
        <div class="panel">
          <div class="panelHead"><h3>ğŸ’¡ Commission Breakdown</h3></div>
          <div class="panelBody">
            <div id="recruiterInfo"></div>
            <div class="breakdownRow">
              <span class="breakdownLabel">From Level 1 recruits</span>
              <span class="breakdownVal" style="color:var(--success)" id="bdL1">GHS â€”</span>
            </div>
            <div class="breakdownRow">
              <span class="breakdownLabel">From Level 2 recruits</span>
              <span class="breakdownVal" style="color:var(--info)" id="bdL2">GHS â€”</span>
            </div>
            <div class="breakdownRow" style="border-top:2px solid var(--line);margin-top:4px">
              <span class="breakdownLabel" style="color:var(--text);font-weight:800">Total Referral Earnings</span>
              <span class="breakdownVal" style="font-size:18px;color:var(--primary)" id="bdTotal">GHS â€”</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- â”€â”€ TAB: Level 1 â”€â”€ -->
    <div id="tab-level1" class="tabPane" style="display:none">
      <div class="panel">
        <div class="panelHead"><h3>Level 1 â€” Direct Recruits</h3><span class="sub" id="l1Count">Loadingâ€¦</span></div>
        <div class="tableWrap">
          <table>
            <thead><tr>
              <th>Agent</th>
              <th>Joined</th>
              <th>Their Sales</th>
              <th>Your Commission</th>
              <th>Sub-Recruits (L2)</th>
            </tr></thead>
            <tbody id="l1TableBody"><tr><td colspan="5" class="spinner">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ TAB: Level 2 â”€â”€ -->
    <div id="tab-level2" class="tabPane" style="display:none">
      <div class="panel">
        <div class="panelHead"><h3>Level 2 â€” Sub-Recruits</h3><span class="sub" id="l2Count">Loadingâ€¦</span></div>
        <div class="tableWrap">
          <table>
            <thead><tr>
              <th>Agent</th>
              <th>Under (Level 1)</th>
              <th>Joined</th>
              <th>Their Sales</th>
              <th>Your Commission</th>
            </tr></thead>
            <tbody id="l2TableBody"><tr><td colspan="5" class="spinner">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ TAB: Earnings â”€â”€ -->
    <div id="tab-earnings" class="tabPane" style="display:none">

      <div class="earningsSummary">
        <div class="earningBox">
          <p class="earningLabel">Lifetime Earnings</p>
          <p class="earningVal" id="earnLifetime">GHS â€”</p>
        </div>
        <div class="earningBox">
          <p class="earningLabel">This Year</p>
          <p class="earningVal" id="earnYear">GHS â€”</p>
        </div>
        <div class="earningBox">
          <p class="earningLabel">This Month</p>
          <p class="earningVal" id="earnMonth">GHS â€”</p>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead"><h3>Earnings History</h3></div>
        <div class="tableWrap">
          <table>
            <thead><tr>
              <th>Date</th>
              <th>From Agent</th>
              <th>Level</th>
              <th>Sale Amount</th>
              <th>Rate</th>
              <th>Earned</th>
            </tr></thead>
            <tbody id="earningsTableBody"><tr><td colspan="6" class="spinner">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â”€â”€ TAB: Tree â”€â”€ -->
    <div id="tab-tree" class="tabPane" style="display:none">
      <div class="panel">
        <div class="panelHead"><h3>ğŸŒ³ My Network Tree</h3></div>
        <div class="panelBody" id="treeBody"><p class="spinner">Loadingâ€¦</p></div>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { requireRole, logout, onAuthChange } from './auth.js';
  import { getAllAgents, getSales, getReferralTree, getReferralCommissions } from './firestore-db.js';

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let agentData = null;
  let agentId   = null;
  let allAgents = [];
  let comms     = [];   // referral commissions where I am beneficiary
  let tree      = { level1: [], level2: [] };
  let allSales  = [];   // all sales (to compute per-recruit sales total)

  // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const allowed = await requireRole('agent');
    if (!allowed) return;

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) { await logout(); window.location.href = 'index.html'; }
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tabPane').forEach(p => p.style.display = 'none');
        document.getElementById('tab-' + btn.dataset.tab).style.display = 'block';
      });
    });

    onAuthChange(async (user) => {
      if (!user) return;

      const allRes = await getAllAgents();
      if (!allRes.success) return;
      allAgents = allRes.data;

      // Retry up to 3 times with backoff â€” Firestore can be slow on first load
      let match = allAgents.find(a => a.firebaseUid === user.uid);
      if (!match) {
        for (let attempt = 2; attempt <= 3; attempt++) {
          await new Promise(r => setTimeout(r, attempt * 800));
          const retryRes = await getAllAgents();
          if (retryRes.success && retryRes.data.length > 0) {
            allAgents = retryRes.data;
            match = allAgents.find(a => a.firebaseUid === user.uid);
            if (match) break;
          }
        }
      }
      if (!match) {
        document.getElementById('sidebarName').textContent = 'Profile error';
        document.getElementById('sidebarId').textContent   = 'Contact admin';
        console.warn('Agent profile not found for uid:', user.uid);
        return;
      }

      agentData = match;
      agentId   = match.id;
      document.getElementById('sidebarName').textContent = match.fullName || match.name || 'Agent';
      document.getElementById('sidebarId').textContent   = match.nationalId || 'â€”';

      await loadAll();
    });
  }

  // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadAll() {
    const [commsRes, treeRes, salesRes] = await Promise.all([
      getReferralCommissions(agentId),
      getReferralTree(agentId),
      getSales(),   // all sales â€” needed for per-recruit revenue totals
    ]);

    comms    = commsRes.success ? commsRes.data           : [];
    tree     = treeRes.success  ? treeRes.data            : { level1: [], level2: [] };
    allSales = salesRes.success ? salesRes.data           : [];

    renderKPIs();
    renderDashboard();
    renderL1Table();
    renderL2Table();
    renderEarnings();
    renderTree();
  }

  // â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderKPIs() {
    const now   = new Date();
    const ms    = new Date(now.getFullYear(), now.getMonth(), 1);
    const me    = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);

    const total   = comms.reduce((s, c) => s + (c.commissionAmount || 0), 0);
    const thisM   = comms.filter(c => { const d = toDate(c.createdAt); return d && d >= ms && d <= me; })
                         .reduce((s, c) => s + (c.commissionAmount || 0), 0);
    const l1Total = comms.filter(c => c.level === 1).reduce((s, c) => s + (c.commissionAmount || 0), 0);
    const l2Total = comms.filter(c => c.level === 2).reduce((s, c) => s + (c.commissionAmount || 0), 0);

    document.getElementById('kpiL1').textContent        = tree.level1.length;
    document.getElementById('kpiL2').textContent        = tree.level2.length;
    document.getElementById('kpiTotal').textContent     = 'GHS ' + fmt(total);
    document.getElementById('kpiTotalHint').textContent = `L1: GHS ${fmt(l1Total)} Â· L2: GHS ${fmt(l2Total)}`;
    document.getElementById('kpiMonth').textContent     = 'GHS ' + fmt(thisM);
    document.getElementById('kpiMonthHint').textContent = comms.filter(c => { const d = toDate(c.createdAt); return d && d >= ms && d <= me; }).length + ' transactions this month';
  }

  // â”€â”€ Dashboard tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDashboard() {
    // Recruiter info chip
    const recruiterEl = document.getElementById('recruiterInfo');
    if (agentData.referredBy) {
      const recruiter = allAgents.find(a => a.id === agentData.referredBy);
      recruiterEl.innerHTML = `<div class="recruiterChip">ğŸ‘¤ You were recruited by <strong>${esc(recruiter?.fullName||recruiter?.name||'â€”')}</strong><small>&nbsp;Â· You pay L1: ${agentData.level1CommissionRate??5}% on your sales</small></div>`;
    } else {
      recruiterEl.innerHTML = `<div class="recruiterChip" style="color:var(--muted);border-color:var(--line)">ğŸ§‘ğŸ¾â€ğŸ’¼ Direct agent â€” not in a referral chain</div>`;
    }

    // Breakdown
    const l1Total = comms.filter(c => c.level === 1).reduce((s, c) => s + (c.commissionAmount || 0), 0);
    const l2Total = comms.filter(c => c.level === 2).reduce((s, c) => s + (c.commissionAmount || 0), 0);
    document.getElementById('bdL1').textContent    = 'GHS ' + fmt(l1Total);
    document.getElementById('bdL2').textContent    = 'GHS ' + fmt(l2Total);
    document.getElementById('bdTotal').textContent = 'GHS ' + fmt(l1Total + l2Total);

    // Recent activity (last 8 commissions)
    const actEl   = document.getElementById('recentActivity');
    const recent  = [...comms].sort((a, b) => (toDate(b.createdAt)||0) - (toDate(a.createdAt)||0)).slice(0, 8);
    if (!recent.length) {
      actEl.innerHTML = '<p class="empty">No referral commissions yet. Your earnings will appear here when your recruits make sales.</p>';
    } else {
      actEl.innerHTML = recent.map(c => {
        const d   = toDate(c.createdAt);
        const ds  = d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short' }) : 'â€”';
        const lvl = c.level === 1 ? 'l1' : 'l2';
        return `<div class="activityItem">
          <div class="activityIco ${lvl}">${c.level === 1 ? 'ğŸ‘¥' : 'ğŸ”—'}</div>
          <div class="activityInfo">
            <strong>${esc(c.sourceAgentName||'â€”')} made a sale</strong>
            <small>${ds} Â· Level ${c.level} Â· Sale: GHS ${fmt(c.saleAmount)}</small>
          </div>
          <div class="activityVal">+GHS ${fmt(c.commissionAmount)}</div>
        </div>`;
      }).join('');
    }
  }

  // â”€â”€ Level 1 table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderL1Table() {
    const body  = document.getElementById('l1TableBody');
    const count = document.getElementById('l1Count');
    count.textContent = `${tree.level1.length} direct recruit${tree.level1.length !== 1 ? 's' : ''}`;

    if (!tree.level1.length) {
      body.innerHTML = `<tr><td colspan="5" class="empty">No Level 1 recruits yet. Ask the admin to link agents to your network.</td></tr>`;
      return;
    }

    // Commission per source agent at level 1
    const commBySource = {};
    comms.filter(c => c.level === 1).forEach(c => {
      commBySource[c.sourceAgentId] = (commBySource[c.sourceAgentId] || 0) + (c.commissionAmount || 0);
    });

    // Sales revenue per agent
    const salesByAgent = {};
    allSales.forEach(s => {
      salesByAgent[s.agentId] = (salesByAgent[s.agentId] || 0) + (s.totalSellingPrice || 0);
    });

    // Count L2 recruits for each L1 agent
    const l2CountFor = {};
    tree.level2.forEach(r => {
      l2CountFor[r.throughAgentId] = (l2CountFor[r.throughAgentId] || 0) + 1;
    });

    body.innerHTML = tree.level1.map(r => {
      const d    = toDate(r.dateCreated);
      const ds   = d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
      const rev  = salesByAgent[r.recruitedAgentId] || 0;
      const earn = commBySource[r.recruitedAgentId] || 0;
      const l2c  = l2CountFor[r.recruitedAgentId]  || 0;
      return `<tr>
        <td><strong>${esc(r.recruitedName||'â€”')}</strong></td>
        <td style="color:var(--muted)">${ds}</td>
        <td>GHS ${fmt(rev, 0)}</td>
        <td><strong class="commVal">GHS ${fmt(earn)}</strong></td>
        <td style="text-align:center"><strong>${l2c}</strong></td>
      </tr>`;
    }).join('');
  }

  // â”€â”€ Level 2 table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderL2Table() {
    const body  = document.getElementById('l2TableBody');
    const count = document.getElementById('l2Count');
    count.textContent = `${tree.level2.length} sub-recruit${tree.level2.length !== 1 ? 's' : ''}`;

    if (!tree.level2.length) {
      body.innerHTML = `<tr><td colspan="5" class="empty">No Level 2 recruits yet. They appear when your Level 1 recruits bring in their own agents.</td></tr>`;
      return;
    }

    const commBySource = {};
    comms.filter(c => c.level === 2).forEach(c => {
      commBySource[c.sourceAgentId] = (commBySource[c.sourceAgentId] || 0) + (c.commissionAmount || 0);
    });

    const salesByAgent = {};
    allSales.forEach(s => {
      salesByAgent[s.agentId] = (salesByAgent[s.agentId] || 0) + (s.totalSellingPrice || 0);
    });

    body.innerHTML = tree.level2.map(r => {
      const d    = toDate(r.dateCreated);
      const ds   = d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
      const rev  = salesByAgent[r.recruitedAgentId] || 0;
      const earn = commBySource[r.recruitedAgentId] || 0;
      return `<tr>
        <td><strong>${esc(r.recruitedName||'â€”')}</strong></td>
        <td>${esc(r.throughAgentName||'â€”')}</td>
        <td style="color:var(--muted)">${ds}</td>
        <td>GHS ${fmt(rev, 0)}</td>
        <td><strong class="commVal">GHS ${fmt(earn)}</strong></td>
      </tr>`;
    }).join('');
  }

  // â”€â”€ Earnings tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderEarnings() {
    const now  = new Date();
    const ms   = new Date(now.getFullYear(), now.getMonth(), 1);
    const me   = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    const ys   = new Date(now.getFullYear(), 0, 1);

    const lifetime = comms.reduce((s, c) => s + (c.commissionAmount || 0), 0);
    const year     = comms.filter(c => { const d = toDate(c.createdAt); return d && d >= ys; })
                          .reduce((s, c) => s + (c.commissionAmount || 0), 0);
    const month    = comms.filter(c => { const d = toDate(c.createdAt); return d && d >= ms && d <= me; })
                          .reduce((s, c) => s + (c.commissionAmount || 0), 0);

    document.getElementById('earnLifetime').textContent = 'GHS ' + fmt(lifetime);
    document.getElementById('earnYear').textContent     = 'GHS ' + fmt(year);
    document.getElementById('earnMonth').textContent    = 'GHS ' + fmt(month);

    const body   = document.getElementById('earningsTableBody');
    const sorted = [...comms].sort((a, b) => (toDate(b.createdAt)||0) - (toDate(a.createdAt)||0));

    if (!sorted.length) {
      body.innerHTML = `<tr><td colspan="6" class="empty">No earnings yet.</td></tr>`;
      return;
    }

    body.innerHTML = sorted.map(c => {
      const d   = toDate(c.createdAt);
      const ds  = d ? d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) : 'â€”';
      return `<tr>
        <td style="color:var(--muted);white-space:nowrap">${ds}</td>
        <td><strong>${esc(c.sourceAgentName||'â€”')}</strong></td>
        <td><span class="badge ${c.level===1?'l1':'l2'}">Level ${c.level}</span></td>
        <td>GHS ${fmt(c.saleAmount)}</td>
        <td style="color:var(--muted)">${c.commissionRate||0}%</td>
        <td><strong class="commVal">+GHS ${fmt(c.commissionAmount)}</strong></td>
      </tr>`;
    }).join('');
  }

  // â”€â”€ Tree tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTree() {
    const el = document.getElementById('treeBody');

    // Commission earned per source agent
    const commBySource = {};
    comms.forEach(c => {
      commBySource[c.sourceAgentId] = (commBySource[c.sourceAgentId] || 0) + (c.commissionAmount || 0);
    });

    const l2Map = {};
    tree.level2.forEach(r => {
      if (!l2Map[r.throughAgentId]) l2Map[r.throughAgentId] = [];
      l2Map[r.throughAgentId].push(r);
    });

    const totalEarned = comms.reduce((s, c) => s + (c.commissionAmount || 0), 0);

    let html = `
      <div class="treeRoot">
        <div class="treeNodeIco">ğŸ‘¤</div>
        <div class="treeNodeInfo">
          <strong>${esc(agentData.fullName||agentData.name||'You')}</strong>
          <small>${esc(agentData.nationalId||agentId)}</small>
          <div class="treeStat">Total referral earnings: GHS ${fmt(totalEarned)} Â· ${tree.level1.length} direct recruit${tree.level1.length!==1?'s':''}</div>
        </div>
      </div>`;

    if (!tree.level1.length) {
      html += `<p class="empty">Your network is empty. Contact your admin to have agents linked to you.</p>`;
      el.innerHTML = html; return;
    }

    html += `<div class="treeLevel">`;
    tree.level1.forEach(r1 => {
      const l2s  = l2Map[r1.recruitedAgentId] || [];
      const earn = commBySource[r1.recruitedAgentId] || 0;
      html += `
        <div class="treeItem">
          <div class="treeIco l1">ğŸ‘¥</div>
          <div class="treeInfo">
            <strong>${esc(r1.recruitedName||'â€”')}</strong>
            <small>Level 1 Â· Direct recruit</small>
          </div>
          <div class="treeSide">
            <div class="val">GHS ${fmt(earn)}</div>
            <div class="lbl">earned</div>
          </div>
        </div>
        ${l2s.length ? `<div class="l2Container">${l2s.map(r2 => {
          const e2 = commBySource[r2.recruitedAgentId] || 0;
          return `<div class="treeItem">
            <div class="treeIco l2">ğŸ”—</div>
            <div class="treeInfo">
              <strong>${esc(r2.recruitedName||'â€”')}</strong>
              <small>Level 2 Â· via ${esc(r1.recruitedName||'â€”')}</small>
            </div>
            <div class="treeSide">
              <div class="val">GHS ${fmt(e2)}</div>
              <div class="lbl">earned</div>
            </div>
          </div>`;
        }).join('')}</div>` : ''}`;
    });
    html += `</div>`;
    el.innerHTML = html;
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toDate(val) {
    if (!val) return null;
    if (val.toDate)  return val.toDate();
    if (val.seconds) return new Date(val.seconds * 1000);
    return new Date(val);
  }
  function fmt(n, dp=2) {
    return Number(n||0).toLocaleString('en-GH', { minimumFractionDigits: dp, maximumFractionDigits: dp });
  }
  function esc(str) {
    return String(str??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  init();
</script>
</body>
</html>